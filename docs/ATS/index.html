<!DOCTYPE html lang="en-us" xml:lang="en-us" xmlns="http://www.w3.org/1999/xhtml">
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-WXC8R75DEN"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-WXC8R75DEN');
      </script>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta http-equiv="Content-Language" content="en-us">
        <!-- Use title if it's in the page YAML frontmatter -->
        <title>Learn ATS in Y Minutes</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

        <link rel="stylesheet" href="/css/index.css">

        <link rel="canonical" href="https://learnxinyminutes.com/docs/ATS/">
        <script>
            var THEME_KEY = "lxiym_theme";
            function set_theme(theme) {
                var el = document.getElementsByTagName("html")[0];
                if (!el) {
                  return;
                }

                if (theme === "dark" ) {
                    el.className = "dark";
                } else {
                    el.className = "light";
                }

                localStorage.setItem(THEME_KEY, theme);
            }

            function load_theme() {
              var theme = localStorage.getItem(THEME_KEY);
              if (theme) {
                set_theme(theme);
              }
            }

            // Attempt immediate application of html style
            load_theme();

            // Backup: do it onload. Will flash, but better than nothing.
            window.addEventListener("load", function(){
              load_theme();
            });
        </script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

        <div class="container">
            <div class="share">
    <span class="sharemsg">
      <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Flearnxinyminutes.com%2Fdocs%2FATS%2F&text=Learn+X+in+Y+minutes%2C+where+X%3DATS">
        Share this page
      </a></span>

      <span class='st_facebook_large' displayText='Facebook'></span>
      <span class='st_twitter_large' displayText='Tweet'></span>
  </div>
  <div class="theme-choice">
    <label id="theme-label">Select theme:</label>
    <button type="button" aria-labelledby="theme-label" onclick="set_theme('light');">light</button>
    <button type="button" aria-labelledby="theme-label" onclick="set_theme('dark');">dark</button>
  </div>
  <h1><a href="/">Learn X in Y minutes</a></h1>
  <h2>Where X=ATS</h2>
    <p class="filelink">
    Get the code:
    <a href="/docs/files/learnats.dats">learnats.dats</a>
    </p>
  <div id="doc">
    <p>ATS is a low-level functional programming language.  It has a powerful type
system which lets you write programs with the same level of control and
efficiency as C, but in a memory safe and type safe way.</p>

<p>The ATS type system supports:</p>

<ul>
<li>Full type erasure: ATS compiles to efficient C</li>
<li>Dependent types, including <a href="http://twelf.org/wiki/LF">LF</a> and proving
metatheorems</li>
<li>Refinement types</li>
<li>Linearity for resource tracking</li>
<li>An effect system that tracks exceptions, mutation, termination, and other
side effects</li>
</ul>

<p>This tutorial is not an introduction to functional programming, dependent types,
or linear types, but rather to how they all fit together in ATS.  That said, ATS
is a very complex language, and this tutorial doesn&rsquo;t cover it all.  Not only
does ATS&rsquo;s type system boast a wide array of confusing features, its
idiosyncratic syntax can make even &ldquo;simple&rdquo; examples hard to understand.  In the
interest of keeping it a reasonable length, this document is meant to give a
taste of ATS, giving a high-level overview of what&rsquo;s possible and how, rather
than attempting to fully explain how everything works.</p>

<p>You can <a href="http://www.ats-lang.org/SERVER/MYCODE/Patsoptaas_serve.php">try ATS in your browser</a>,
or install it from <a href="http://www.ats-lang.org/">http://www.ats-lang.org/</a>.</p>
<div class="highlight"><pre><span></span><span class="o">//</span> <span class="nc">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">library</span>
<span class="o">#</span><span class="k">include</span> <span class="s2">&quot;share/atspre_define.hats&quot;</span>
<span class="o">#</span><span class="k">include</span> <span class="s2">&quot;share/atspre_staload.hats&quot;</span>

<span class="o">//</span> <span class="nc">To</span> <span class="n">compile</span><span class="o">,</span> <span class="n">either</span> <span class="n">use</span>
<span class="o">//</span>   <span class="o">$</span> <span class="n">patscc</span> <span class="o">-</span><span class="nc">DATS_MEMALLOC_LIBC</span> <span class="n">program</span><span class="o">.</span><span class="n">dats</span> <span class="o">-</span><span class="n">o</span> <span class="n">program</span>
<span class="o">//</span> <span class="ow">or</span> <span class="n">install</span> <span class="n">the</span> <span class="n">ats</span><span class="o">-</span><span class="n">acc</span> <span class="n">wrapper</span> <span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sparverius</span><span class="o">/</span><span class="n">ats</span><span class="o">-</span><span class="n">acc</span> <span class="ow">and</span> <span class="n">use</span>
<span class="o">//</span>   <span class="o">$</span> <span class="n">acc</span> <span class="n">pc</span> <span class="n">program</span><span class="o">.</span><span class="n">dats</span>

<span class="o">//</span> <span class="nc">C</span><span class="o">-</span><span class="n">style</span> <span class="n">line</span> <span class="n">comments</span>
<span class="o">/*</span> <span class="ow">and</span> <span class="nc">C</span><span class="o">-</span><span class="n">style</span> <span class="n">block</span> <span class="n">comments</span> <span class="o">*/</span>
<span class="c">(* as well as ML-style block comments *)</span>

<span class="o">/***************</span> <span class="nc">Part</span> <span class="mi">1</span><span class="o">:</span> <span class="n">the</span> <span class="nc">ML</span> <span class="n">fragment</span> <span class="o">****************/</span>

<span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print</span> <span class="s2">&quot;Hello, World!</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="o">//</span> <span class="nc">No</span> <span class="n">currying</span>
<span class="n">fn</span> <span class="n">add</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">int</span><span class="o">,</span> <span class="n">y</span><span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">//</span> <span class="n">fn</span> <span class="n">vs</span> <span class="k">fun</span> <span class="n">is</span> <span class="n">like</span> <span class="n">the</span> <span class="n">difference</span> <span class="n">between</span> <span class="k">let</span> <span class="ow">and</span> <span class="k">let</span> <span class="k">rec</span> <span class="k">in</span> <span class="nc">OCaml</span><span class="o">/</span><span class="nc">F</span><span class="o">#</span>
<span class="k">fun</span> <span class="n">fact</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="kt">int</span><span class="o">):</span> <span class="kt">int</span> <span class="o">=</span> <span class="k">if</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n</span> <span class="o">*</span> <span class="n">fact</span> <span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span>

<span class="o">//</span> <span class="nc">Multi</span><span class="o">-</span><span class="n">argument</span> <span class="n">functions</span> <span class="n">need</span> <span class="n">parentheses</span> <span class="k">when</span> <span class="n">you</span> <span class="n">call</span> <span class="n">them</span><span class="o">;</span> <span class="n">single</span><span class="o">-</span><span class="n">argument</span>
<span class="o">//</span> <span class="n">functions</span> <span class="n">can</span> <span class="n">omit</span> <span class="n">parentheses</span>
<span class="k">val</span> <span class="n">forty_three</span> <span class="o">=</span> <span class="n">add</span> <span class="o">(</span><span class="n">fact</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">19</span><span class="o">)</span>

<span class="o">//</span> <span class="k">let</span> <span class="n">is</span> <span class="n">like</span> <span class="k">let</span> <span class="k">in</span> <span class="nc">SML</span>
<span class="n">fn</span> <span class="n">sum_and_prod</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">int</span><span class="o">,</span> <span class="n">y</span><span class="o">:</span> <span class="kt">int</span><span class="o">):</span> <span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">val</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">val</span> <span class="n">prod</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
  <span class="k">in</span> <span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">prod</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="k">&#39;type&#39;</span> <span class="n">is</span> <span class="n">the</span> <span class="k">type</span> <span class="k">of</span> <span class="n">all</span> <span class="n">heap</span><span class="o">-</span><span class="n">allocated</span><span class="o">,</span> <span class="n">non</span><span class="o">-</span><span class="n">linear</span> <span class="n">types</span>
<span class="o">//</span> <span class="nc">Polymorphic</span> <span class="n">parameters</span> <span class="n">go</span> <span class="k">in</span> <span class="o">{}</span> <span class="n">after</span> <span class="n">the</span> <span class="k">function</span> <span class="n">name</span>
<span class="n">fn</span> <span class="n">id</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="k">type</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span>

<span class="o">//</span> <span class="n">ints</span> <span class="n">aren&#39;t</span> <span class="n">heap</span><span class="o">-</span><span class="n">allocated</span><span class="o">,</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can&#39;t</span> <span class="n">pass</span> <span class="n">them</span> <span class="k">to</span> <span class="k">&#39;</span><span class="n">id&#39;</span>
<span class="o">//</span> <span class="k">val</span> <span class="n">y</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">id</span> <span class="mi">7</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>

<span class="o">//</span> <span class="k">&#39;</span><span class="n">t</span><span class="o">@</span><span class="n">ype&#39;</span> <span class="n">is</span> <span class="n">the</span> <span class="k">type</span> <span class="k">of</span> <span class="n">all</span> <span class="n">non</span><span class="o">-</span><span class="n">linear</span> <span class="n">potentially</span> <span class="n">unboxed</span> <span class="n">types</span><span class="o">.</span> <span class="nc">It</span> <span class="n">is</span> <span class="n">a</span>
<span class="o">//</span> <span class="n">supertype</span> <span class="k">of</span> <span class="k">&#39;type&#39;</span><span class="o">.</span>
<span class="o">//</span> <span class="nc">Templated</span> <span class="n">parameters</span> <span class="n">go</span> <span class="k">in</span> <span class="o">{}</span> <span class="n">before</span> <span class="n">the</span> <span class="k">function</span> <span class="n">name</span>
<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">id2</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span>

<span class="k">val</span> <span class="n">y</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">id2</span> <span class="mi">7</span> <span class="o">//</span> <span class="n">works</span>

<span class="o">//</span> <span class="n">can&#39;t</span> <span class="n">have</span> <span class="n">polymorphic</span> <span class="n">t</span><span class="o">@</span><span class="n">ype</span> <span class="n">parameters</span>
<span class="o">//</span> <span class="n">fn</span> <span class="n">id3</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>

<span class="o">//</span> <span class="n">explicity</span> <span class="n">specifying</span> <span class="k">type</span> <span class="n">parameters</span><span class="o">:</span>
<span class="n">fn</span> <span class="n">id4</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="k">type</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="n">id</span> <span class="o">{</span><span class="n">a</span><span class="o">}</span> <span class="n">x</span> <span class="o">//</span> <span class="o">{}</span> <span class="k">for</span> <span class="n">non</span><span class="o">-</span><span class="n">template</span> <span class="n">parameters</span>
<span class="n">fn</span> <span class="n">id5</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="k">type</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="n">id2</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">//</span> <span class="o">&lt;&gt;</span> <span class="k">for</span> <span class="n">template</span> <span class="n">parameters</span>
<span class="n">fn</span> <span class="n">id6</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="k">type</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="n">id</span> <span class="o">{..}</span> <span class="n">x</span> <span class="o">//</span> <span class="o">{..}</span> <span class="k">to</span> <span class="n">explicitly</span> <span class="n">infer</span> <span class="n">it</span>

<span class="o">//</span> <span class="nc">Heap</span> <span class="n">allocated</span> <span class="n">shareable</span> <span class="n">datatypes</span>
<span class="o">//</span> <span class="n">using</span> <span class="n">datatypes</span> <span class="n">leaks</span> <span class="n">memory</span>
<span class="n">datatype</span> <span class="nc">These</span> <span class="o">(</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">,</span> <span class="n">b</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">)</span> <span class="o">=</span> <span class="nc">This</span> <span class="k">of</span> <span class="n">a</span>
                                  <span class="o">|</span> <span class="nc">That</span> <span class="k">of</span> <span class="n">b</span>
                                  <span class="o">|</span> <span class="nc">These</span> <span class="k">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span>

<span class="o">//</span> <span class="nc">Pattern</span> <span class="n">matching</span> <span class="n">using</span> <span class="k">&#39;</span><span class="n">case&#39;</span>
<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">:</span> <span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">from_these</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">,</span> <span class="n">y</span><span class="o">:</span> <span class="n">b</span><span class="o">,</span> <span class="n">these</span><span class="o">:</span> <span class="nc">These</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)):</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">case</span> <span class="n">these</span> <span class="k">of</span>
  <span class="o">|</span> <span class="nc">This</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">//</span> <span class="nc">Shadowing</span> <span class="k">of</span> <span class="n">variable</span> <span class="n">names</span> <span class="n">is</span> <span class="n">fine</span><span class="o">;</span> <span class="n">here</span><span class="o">,</span> <span class="n">x</span> <span class="n">shadows</span>
                      <span class="o">//</span> <span class="n">the</span> <span class="n">parameter</span> <span class="n">x</span>
  <span class="o">|</span> <span class="nc">That</span><span class="o">(</span><span class="n">y</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">These</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span>

<span class="o">//</span> <span class="nc">Partial</span> <span class="n">pattern</span> <span class="k">match</span> <span class="n">using</span> <span class="k">&#39;</span><span class="n">case</span><span class="o">-</span><span class="k">&#39;</span>
<span class="o">//</span> <span class="nc">Will</span> <span class="n">throw</span> <span class="n">an</span> <span class="k">exception</span> <span class="k">if</span> <span class="n">passed</span> <span class="nc">This</span>
<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">unwrap_that</span> <span class="o">(</span><span class="n">these</span><span class="o">:</span> <span class="nc">These</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)):</span> <span class="n">b</span> <span class="o">=</span>
  <span class="n">case</span><span class="o">-</span> <span class="n">these</span> <span class="k">of</span>
  <span class="o">|</span> <span class="nc">That</span><span class="o">(</span><span class="n">y</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">y</span>
  <span class="o">|</span> <span class="nc">These</span><span class="o">(_,</span> <span class="n">y</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">y</span>


<span class="o">/***************</span> <span class="nc">Part</span> <span class="mi">2</span><span class="o">:</span> <span class="n">refinements</span> <span class="o">****************/</span>

<span class="o">//</span> <span class="nc">Parameterize</span> <span class="n">functions</span> <span class="n">by</span> <span class="n">what</span> <span class="n">values</span> <span class="n">they</span> <span class="n">take</span> <span class="ow">and</span> <span class="n">return</span>
<span class="n">fn</span> <span class="n">cool_add</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">{</span><span class="n">m</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">y</span><span class="o">:</span> <span class="kt">int</span> <span class="n">m</span><span class="o">):</span> <span class="kt">int</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="n">m</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">//</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="n">is</span> <span class="n">a</span> <span class="kt">list</span> <span class="k">of</span> <span class="n">n</span> <span class="n">a&#39;s</span>
<span class="k">fun</span> <span class="n">square_all</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span><span class="o">:</span> <span class="kt">list</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="n">n</span><span class="o">)):</span> <span class="kt">list</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">case</span> <span class="n">xs</span> <span class="k">of</span>
  <span class="o">|</span> <span class="n">list_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="n">list_nil</span><span class="bp">()</span>
  <span class="o">|</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">rest</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">,</span> <span class="n">square_all</span> <span class="n">rest</span><span class="o">)</span>

<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">get_first</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span> <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span><span class="o">:</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)):</span> <span class="n">a</span> <span class="o">=</span>
  <span class="n">case</span><span class="o">+</span> <span class="n">xs</span> <span class="k">of</span> <span class="o">//</span> <span class="sc">&#39;+&#39;</span> <span class="n">asks</span> <span class="nc">ATS</span> <span class="k">to</span> <span class="n">prove</span> <span class="n">it&#39;s</span> <span class="n">total</span>
  <span class="o">|</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="o">_)</span> <span class="o">=&gt;</span> <span class="n">x</span>

<span class="o">//</span> <span class="nc">Can&#39;t</span> <span class="n">run</span> <span class="n">get_first</span> <span class="n">on</span> <span class="n">lists</span> <span class="k">of</span> <span class="n">length</span> <span class="mi">0</span>
<span class="o">//</span> <span class="k">val</span> <span class="n">x</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">get_first</span> <span class="o">(</span><span class="n">list_nil</span><span class="bp">()</span><span class="o">)</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>

<span class="o">//</span> <span class="k">in</span> <span class="n">the</span> <span class="n">stdlib</span><span class="o">:</span>
<span class="o">//</span> <span class="n">sortdef</span> <span class="n">nat</span> <span class="o">=</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span> <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">}</span>
<span class="o">//</span> <span class="n">sortdef</span> <span class="n">pos</span> <span class="o">=</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span> <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">}</span>

<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">also_get_first</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">pos</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span><span class="o">:</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)):</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">val</span><span class="o">+</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="o">_)</span> <span class="o">=</span> <span class="n">xs</span> <span class="o">//</span> <span class="k">val</span><span class="o">+</span> <span class="n">also</span> <span class="n">works</span>
  <span class="k">in</span> <span class="n">x</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">tail</span><span class="o">-</span><span class="n">recursive</span> <span class="n">reverse</span>
<span class="k">fun</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">reverse</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span><span class="o">:</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)):</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="o">//</span> <span class="n">local</span> <span class="n">functions</span> <span class="n">can</span> <span class="n">use</span> <span class="k">type</span> <span class="n">variables</span> <span class="n">from</span> <span class="n">their</span> <span class="n">enclosing</span> <span class="n">scope</span>
    <span class="o">//</span> <span class="n">this</span> <span class="n">one</span> <span class="n">uses</span> <span class="n">both</span> <span class="sc">&#39;a&#39;</span> <span class="ow">and</span> <span class="sc">&#39;n&#39;</span>
    <span class="k">fun</span> <span class="n">rev_helper</span> <span class="o">{</span><span class="n">i</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span><span class="o">:</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="o">),</span> <span class="n">acc</span><span class="o">:</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">i</span><span class="o">)):</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">=</span>
      <span class="n">case</span> <span class="n">xs</span> <span class="k">of</span>
      <span class="o">|</span> <span class="n">list_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="n">acc</span>
      <span class="o">|</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">rest</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">rev_helper</span><span class="o">(</span><span class="n">rest</span><span class="o">,</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">acc</span><span class="o">))</span>
  <span class="k">in</span> <span class="n">rev_helper</span><span class="o">(</span><span class="n">xs</span><span class="o">,</span> <span class="n">list_nil</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="nc">ATS</span> <span class="n">has</span> <span class="n">three</span> <span class="n">context</span><span class="o">-</span><span class="n">dependent</span> <span class="n">namespaces</span>
<span class="o">//</span> <span class="n">the</span> <span class="n">two</span> <span class="k">&#39;</span><span class="kt">int</span><span class="k">&#39;</span><span class="n">s</span> <span class="n">mean</span> <span class="n">different</span> <span class="n">things</span> <span class="k">in</span> <span class="n">this</span> <span class="n">example</span><span class="o">,</span> <span class="k">as</span> <span class="k">do</span> <span class="n">the</span> <span class="n">two</span> <span class="sc">&#39;n&#39;</span><span class="n">s</span>
<span class="n">fn</span> <span class="n">namespace_example</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">):</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
<span class="o">//</span>                      <span class="o">^^^</span>                         <span class="n">sort</span> <span class="n">namespace</span>
<span class="o">//</span>                    <span class="o">^</span>          <span class="o">^^^</span> <span class="o">^</span>   <span class="o">^^^</span> <span class="o">^</span>      <span class="n">statics</span> <span class="n">namespace</span>
<span class="o">//</span> <span class="o">^^^^^^^^^^^^^^^^^</span>          <span class="o">^</span>                  <span class="o">^</span>  <span class="k">value</span> <span class="n">namespace</span>

<span class="o">//</span> <span class="n">a</span> <span class="n">termination</span> <span class="n">metric</span> <span class="n">can</span> <span class="n">go</span> <span class="k">in</span> <span class="o">.&lt;</span> <span class="o">&gt;.</span>
<span class="o">//</span> <span class="n">it</span> <span class="n">must</span> <span class="n">decrease</span> <span class="n">on</span> <span class="n">each</span> <span class="n">recursive</span> <span class="n">call</span>
<span class="o">//</span> <span class="k">then</span> <span class="nc">ATS</span> <span class="n">will</span> <span class="n">prove</span> <span class="n">it</span> <span class="n">doesn&#39;t</span> <span class="n">infinitely</span> <span class="n">recurse</span>
<span class="k">fun</span> <span class="n">terminating_factorial</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">.&lt;</span><span class="n">n</span><span class="o">&gt;.</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">):</span> <span class="kt">int</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n</span> <span class="o">*</span> <span class="n">terminating_factorial</span> <span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span>


<span class="o">/***************</span> <span class="nc">Part</span> <span class="mi">3</span><span class="o">:</span> <span class="n">the</span> <span class="nc">LF</span> <span class="n">fragment</span> <span class="o">****************/</span>

<span class="o">//</span> <span class="nc">ATS</span> <span class="n">supports</span> <span class="n">proving</span> <span class="n">theorems</span> <span class="k">in</span> <span class="nc">LF</span> <span class="o">(</span><span class="n">http</span><span class="o">://</span><span class="n">twelf</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">wiki</span><span class="o">/</span><span class="nc">LF</span><span class="o">)</span>

<span class="o">//</span> <span class="nc">Relations</span> <span class="n">are</span> <span class="n">represented</span> <span class="n">by</span> <span class="n">inductive</span> <span class="n">types</span>

<span class="o">//</span> <span class="nc">Proofs</span> <span class="n">that</span> <span class="n">the</span> <span class="n">nth</span> <span class="n">fibonacci</span> <span class="n">number</span> <span class="n">is</span> <span class="n">f</span>
<span class="n">dataprop</span> <span class="nc">Fib</span><span class="o">(</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">,</span> <span class="n">m</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">FibZero</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">FibOne</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">{</span><span class="n">n</span><span class="o">,</span> <span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">:</span> <span class="kt">int</span><span class="o">}</span> <span class="nc">FibInd</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">f1</span> <span class="o">+</span> <span class="n">f2</span><span class="o">)</span> <span class="k">of</span> <span class="o">(</span><span class="nc">Fib</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">f1</span><span class="o">),</span> <span class="nc">Fib</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="o">,</span><span class="n">f2</span><span class="o">))</span>

<span class="o">//</span> <span class="nc">Proved</span><span class="o">-</span><span class="n">correct</span> <span class="n">fibonacci</span> <span class="n">implementation</span>
<span class="o">//</span> <span class="o">[</span><span class="nc">A</span><span class="o">]</span> <span class="nc">B</span> <span class="n">is</span> <span class="n">an</span> <span class="n">existential</span> <span class="k">type</span><span class="o">:</span> <span class="s2">&quot;there exists A such that B&quot;</span>
<span class="o">//</span> <span class="o">(</span><span class="n">proof</span> <span class="o">|</span> <span class="k">value</span><span class="o">)</span>
<span class="k">fun</span> <span class="n">fib</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">.&lt;</span><span class="n">n</span><span class="o">&gt;.</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">):</span> <span class="o">[</span><span class="n">f</span><span class="o">:</span><span class="kt">int</span><span class="o">]</span> <span class="o">(</span><span class="nc">Fib</span><span class="o">(</span><span class="n">n</span><span class="o">,</span><span class="n">f</span><span class="o">)</span> <span class="o">|</span> <span class="kt">int</span> <span class="n">f</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span><span class="nc">FibZero</span> <span class="o">|</span> <span class="mi">0</span><span class="o">)</span> <span class="k">else</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="o">(</span><span class="nc">FibOne</span> <span class="o">|</span> <span class="mi">1</span><span class="o">)</span> <span class="k">else</span>
  <span class="k">let</span>
    <span class="k">val</span> <span class="o">(</span><span class="n">proof1</span> <span class="o">|</span> <span class="n">val1</span><span class="o">)</span> <span class="o">=</span> <span class="n">fib</span> <span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span>
    <span class="k">val</span> <span class="o">(</span><span class="n">proof2</span> <span class="o">|</span> <span class="n">val2</span><span class="o">)</span> <span class="o">=</span> <span class="n">fib</span> <span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="o">)</span>
  <span class="o">//</span> <span class="n">the</span> <span class="n">existential</span> <span class="k">type</span> <span class="n">is</span> <span class="n">inferred</span>
  <span class="k">in</span> <span class="o">(</span><span class="nc">FibInd</span><span class="o">(</span><span class="n">proof1</span><span class="o">,</span> <span class="n">proof2</span><span class="o">)</span> <span class="o">|</span> <span class="n">val1</span> <span class="o">+</span> <span class="n">val2</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="nc">Faster</span> <span class="n">proved</span><span class="o">-</span><span class="n">correct</span> <span class="n">fibonacci</span> <span class="n">implementation</span>
<span class="n">fn</span> <span class="n">fib_tail</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">):</span> <span class="o">[</span><span class="n">f</span><span class="o">:</span><span class="kt">int</span><span class="o">]</span> <span class="o">(</span><span class="nc">Fib</span><span class="o">(</span><span class="n">n</span><span class="o">,</span><span class="n">f</span><span class="o">)</span> <span class="o">|</span> <span class="kt">int</span> <span class="n">f</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">fun</span> <span class="n">loop</span> <span class="o">{</span><span class="n">i</span><span class="o">:</span><span class="kt">int</span> <span class="o">|</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">}</span> <span class="o">{</span><span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">:</span> <span class="kt">int</span><span class="o">}</span> <span class="o">.&lt;</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="o">&gt;.</span>
          <span class="o">(</span><span class="n">p1</span><span class="o">:</span> <span class="nc">Fib</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">f1</span><span class="o">),</span> <span class="n">p2</span><span class="o">:</span> <span class="nc">Fib</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">f2</span><span class="o">)</span>
          <span class="o">|</span> <span class="n">i</span><span class="o">:</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">f1</span><span class="o">:</span> <span class="kt">int</span> <span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">:</span> <span class="kt">int</span> <span class="n">f2</span><span class="o">,</span> <span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span>
          <span class="o">):</span> <span class="o">[</span><span class="n">f</span><span class="o">:</span><span class="kt">int</span><span class="o">]</span> <span class="o">(</span><span class="nc">Fib</span><span class="o">(</span><span class="n">n</span><span class="o">,</span><span class="n">f</span><span class="o">)</span> <span class="o">|</span> <span class="kt">int</span> <span class="n">f</span><span class="o">)</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">p2</span> <span class="o">|</span> <span class="n">f2</span><span class="o">)</span>
      <span class="k">else</span> <span class="n">loop</span> <span class="o">(</span><span class="n">p2</span><span class="o">,</span> <span class="nc">FibInd</span><span class="o">(</span><span class="n">p2</span><span class="o">,</span><span class="n">p1</span><span class="o">)</span> <span class="o">|</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">f2</span><span class="o">,</span> <span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span>
  <span class="k">in</span> <span class="k">if</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span><span class="nc">FibZero</span> <span class="o">|</span> <span class="mi">0</span><span class="o">)</span> <span class="k">else</span> <span class="n">loop</span> <span class="o">(</span><span class="nc">FibZero</span><span class="o">,</span> <span class="nc">FibOne</span> <span class="o">|</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="nc">Proof</span><span class="o">-</span><span class="n">level</span> <span class="n">lists</span> <span class="k">of</span> <span class="n">ints</span><span class="o">,</span> <span class="k">of</span> <span class="k">type</span> <span class="k">&#39;</span><span class="n">sort&#39;</span>
<span class="n">datasort</span> <span class="nc">IntList</span> <span class="o">=</span> <span class="nc">ILNil</span> <span class="k">of</span> <span class="bp">()</span>
                 <span class="o">|</span> <span class="nc">ILCons</span> <span class="k">of</span> <span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="nc">IntList</span><span class="o">)</span>

<span class="o">//</span> <span class="nc">ILAppend</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">,</span><span class="n">z</span><span class="o">)</span> <span class="n">iff</span> <span class="n">x</span> <span class="o">++</span> <span class="n">y</span> <span class="o">=</span> <span class="n">z</span>
<span class="n">dataprop</span> <span class="nc">ILAppend</span><span class="o">(</span><span class="nc">IntList</span><span class="o">,</span> <span class="nc">IntList</span><span class="o">,</span> <span class="nc">IntList</span><span class="o">)</span> <span class="o">=</span>
  <span class="o">|</span> <span class="o">{</span><span class="n">y</span><span class="o">:</span><span class="nc">IntList</span><span class="o">}</span> <span class="nc">AppendNil</span><span class="o">(</span><span class="nc">ILNil</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">{</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">,</span><span class="n">z</span><span class="o">:</span> <span class="nc">IntList</span><span class="o">}</span>
    <span class="nc">AppendCons</span><span class="o">(</span><span class="nc">ILCons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">x</span><span class="o">),</span> <span class="n">y</span><span class="o">,</span> <span class="nc">ILCons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">z</span><span class="o">))</span> <span class="k">of</span> <span class="nc">ILAppend</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">,</span><span class="n">z</span><span class="o">)</span>

<span class="o">//</span> <span class="n">prfuns</span><span class="o">/</span><span class="n">prfns</span> <span class="n">are</span> <span class="n">compile</span><span class="o">-</span><span class="n">time</span> <span class="n">functions</span> <span class="n">acting</span> <span class="n">on</span> <span class="n">proofs</span>

<span class="o">//</span> <span class="n">metatheorem</span><span class="o">:</span> <span class="n">append</span> <span class="n">is</span> <span class="n">total</span>
<span class="n">prfun</span> <span class="n">append_total</span> <span class="o">{</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">:</span> <span class="nc">IntList</span><span class="o">}</span> <span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;.</span> <span class="bp">()</span><span class="o">:</span> <span class="o">[</span><span class="n">z</span><span class="o">:</span><span class="nc">IntList</span><span class="o">]</span> <span class="nc">ILAppend</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">,</span><span class="n">z</span><span class="o">)</span>
  <span class="o">=</span> <span class="n">scase</span> <span class="n">x</span> <span class="k">of</span> <span class="o">//</span> <span class="n">scase</span> <span class="n">lets</span> <span class="n">you</span> <span class="n">inspect</span> <span class="n">static</span> <span class="n">arguments</span> <span class="o">(</span><span class="n">only</span> <span class="k">in</span> <span class="n">prfuns</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">ILNil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="nc">AppendNil</span>
  <span class="o">|</span> <span class="nc">ILCons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">rest</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">AppendCons</span><span class="o">(</span><span class="n">append_total</span><span class="bp">()</span><span class="o">)</span>


<span class="o">/***************</span> <span class="nc">Part</span> <span class="mi">4</span><span class="o">:</span> <span class="n">views</span> <span class="o">****************/</span>

<span class="o">//</span> <span class="n">views</span> <span class="n">are</span> <span class="n">like</span> <span class="n">props</span><span class="o">,</span> <span class="n">but</span> <span class="n">linear</span><span class="o">;</span> <span class="n">ie</span> <span class="n">they</span> <span class="n">must</span> <span class="n">be</span> <span class="n">consumed</span> <span class="n">exactly</span> <span class="n">once</span>
<span class="o">//</span> <span class="n">prop</span> <span class="n">is</span> <span class="n">a</span> <span class="n">subtype</span> <span class="k">of</span> <span class="n">view</span>

<span class="o">//</span> <span class="k">&#39;type</span> <span class="o">@</span> <span class="n">address&#39;</span> <span class="n">is</span> <span class="n">the</span> <span class="n">most</span> <span class="n">basic</span> <span class="n">view</span>

<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">read_ptr</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="n">a</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="o">(</span><span class="n">a</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="o">//</span> <span class="o">!</span><span class="n">p</span> <span class="n">searches</span> <span class="k">for</span> <span class="n">usable</span> <span class="n">proofs</span> <span class="n">that</span> <span class="n">say</span> <span class="n">something</span> <span class="n">is</span> <span class="n">at</span> <span class="n">that</span> <span class="n">address</span>
    <span class="k">val</span> <span class="n">x</span> <span class="o">=</span> <span class="o">!</span><span class="n">p</span>
  <span class="k">in</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="n">x</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">oops</span><span class="o">,</span> <span class="n">tried</span> <span class="k">to</span> <span class="n">dereference</span> <span class="n">a</span> <span class="n">potentially</span> <span class="n">invalid</span> <span class="n">pointer</span>
<span class="o">//</span> <span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">bad</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="n">a</span> <span class="o">=</span> <span class="o">!</span><span class="n">p</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>

<span class="o">//</span> <span class="n">oops</span><span class="o">,</span> <span class="n">dropped</span> <span class="n">the</span> <span class="n">proof</span> <span class="o">(</span><span class="n">leaked</span> <span class="n">the</span> <span class="n">memory</span><span class="o">)</span>
<span class="o">//</span> <span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">bad</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="n">a</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="n">a</span> <span class="o">=</span> <span class="o">!</span><span class="n">p</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>

<span class="n">fn</span> <span class="n">inc_at_ptr</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="kt">int</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="o">(</span><span class="kt">int</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">void</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="o">//</span> <span class="o">!</span><span class="n">p</span> <span class="o">:=</span> <span class="k">value</span> <span class="n">writes</span> <span class="k">value</span> <span class="k">to</span> <span class="n">the</span> <span class="n">location</span> <span class="n">at</span> <span class="n">p</span>
    <span class="o">//</span> <span class="n">like</span> <span class="o">!</span><span class="n">p</span><span class="o">,</span> <span class="n">it</span> <span class="n">implicitly</span> <span class="n">searches</span> <span class="k">for</span> <span class="n">usable</span> <span class="n">proofs</span> <span class="n">that</span> <span class="n">are</span> <span class="k">in</span> <span class="n">scope</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!</span><span class="n">p</span> <span class="o">:=</span> <span class="o">!</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">in</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">threading</span> <span class="n">proofs</span> <span class="n">through</span> <span class="n">gets</span> <span class="n">annoying</span>
<span class="n">fn</span> <span class="n">inc_three_times</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="kt">int</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="o">(</span><span class="kt">int</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">void</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">val</span> <span class="o">(</span><span class="n">pf2</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="n">inc_at_ptr</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="n">p</span><span class="o">)</span>
    <span class="k">val</span> <span class="o">(</span><span class="n">pf3</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="n">inc_at_ptr</span> <span class="o">(</span><span class="n">pf2</span> <span class="o">|</span> <span class="n">p</span><span class="o">)</span>
    <span class="k">val</span> <span class="o">(</span><span class="n">pf4</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="n">inc_at_ptr</span> <span class="o">(</span><span class="n">pf3</span> <span class="o">|</span> <span class="n">p</span><span class="o">)</span>
  <span class="k">in</span> <span class="o">(</span><span class="n">pf4</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">so</span> <span class="n">there&#39;s</span> <span class="n">special</span> <span class="n">syntactic</span> <span class="n">sugar</span> <span class="k">for</span> <span class="k">when</span> <span class="n">you</span> <span class="n">don&#39;t</span> <span class="n">consume</span> <span class="n">a</span> <span class="n">proof</span>
<span class="n">fn</span> <span class="n">dec_at_ptr</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="o">!</span><span class="kt">int</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="o">!</span><span class="n">p</span> <span class="o">:=</span> <span class="o">!</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span>           <span class="o">//</span> <span class="o">^</span> <span class="n">note</span> <span class="n">the</span> <span class="n">exclamation</span> <span class="n">point</span>

<span class="n">fn</span> <span class="n">dec_three_times</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="o">!</span><span class="kt">int</span><span class="o">@</span><span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">dec_at_ptr</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="n">p</span><span class="o">)</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">dec_at_ptr</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="n">p</span><span class="o">)</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">dec_at_ptr</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="n">p</span><span class="o">)</span>
  <span class="k">in</span> <span class="bp">()</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">dataview</span> <span class="n">is</span> <span class="n">like</span> <span class="n">dataprop</span><span class="o">,</span> <span class="n">but</span> <span class="n">linear</span>
<span class="o">//</span> <span class="nc">A</span> <span class="n">proof</span> <span class="n">that</span> <span class="n">either</span> <span class="n">the</span> <span class="n">address</span> <span class="n">is</span> <span class="n">null</span><span class="o">,</span> <span class="ow">or</span> <span class="n">there</span> <span class="n">is</span> <span class="n">a</span> <span class="k">value</span> <span class="n">there</span>
<span class="n">dataview</span> <span class="nc">MaybeNull</span><span class="o">(</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">,</span> <span class="n">addr</span><span class="o">)</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">NullPtr</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">null</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span> <span class="o">|</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">null</span><span class="o">}</span> <span class="nc">NonNullPtr</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">l</span><span class="o">)</span> <span class="k">of</span> <span class="o">(</span><span class="n">a</span> <span class="o">@</span> <span class="n">l</span><span class="o">)</span>

<span class="n">fn</span> <span class="n">maybe_inc</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="o">!</span><span class="nc">MaybeNull</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="n">l</span><span class="o">)</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">ptr1_is_null</span> <span class="n">p</span>
  <span class="k">then</span> <span class="bp">()</span>
  <span class="k">else</span> <span class="k">let</span>
    <span class="o">//</span> <span class="nc">Deconstruct</span> <span class="n">the</span> <span class="n">proof</span> <span class="k">to</span> <span class="n">access</span> <span class="n">the</span> <span class="n">proof</span> <span class="k">of</span> <span class="n">a</span> <span class="o">@</span> <span class="n">l</span>
    <span class="n">prval</span> <span class="nc">NonNullPtr</span><span class="o">(</span><span class="n">value_exists</span><span class="o">)</span> <span class="o">=</span> <span class="n">pf</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!</span><span class="n">p</span> <span class="o">:=</span> <span class="o">!</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="o">//</span> <span class="nc">Reconstruct</span> <span class="n">it</span> <span class="n">again</span> <span class="k">for</span> <span class="n">the</span> <span class="n">caller</span>
    <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pf</span> <span class="o">:=</span> <span class="nc">NonNullPtr</span><span class="o">(</span><span class="n">value_exists</span><span class="o">)</span>
  <span class="k">in</span> <span class="bp">()</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">array_v</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">l</span><span class="o">,</span><span class="n">n</span><span class="o">)</span> <span class="n">represents</span> <span class="ow">and</span> <span class="kt">array</span> <span class="k">of</span> <span class="n">n</span> <span class="n">a&#39;s</span> <span class="n">at</span> <span class="n">location</span> <span class="n">l</span>
<span class="o">//</span> <span class="n">this</span> <span class="n">gets</span> <span class="n">compiled</span> <span class="n">into</span> <span class="n">an</span> <span class="n">efficient</span> <span class="k">for</span> <span class="n">loop</span><span class="o">,</span> <span class="n">since</span> <span class="n">all</span> <span class="n">proofs</span> <span class="n">are</span> <span class="n">erased</span>
<span class="n">fn</span> <span class="n">sum_array</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">pf</span><span class="o">:</span> <span class="o">!</span><span class="n">array_v</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span><span class="n">l</span><span class="o">,</span><span class="n">n</span><span class="o">)</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">,</span> <span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">):</span> <span class="kt">int</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">fun</span> <span class="n">loop</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">.&lt;</span><span class="n">n</span><span class="o">&gt;.</span> <span class="o">(</span>
      <span class="n">pf</span><span class="o">:</span> <span class="o">!</span><span class="n">array_v</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span><span class="n">l</span><span class="o">,</span><span class="n">n</span><span class="o">)</span>
    <span class="o">|</span> <span class="n">ptr</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">,</span>
      <span class="n">length</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span>
      <span class="n">acc</span><span class="o">:</span> <span class="kt">int</span>
    <span class="o">):</span> <span class="kt">int</span> <span class="o">=</span> <span class="k">if</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">acc</span>
      <span class="k">else</span> <span class="k">let</span>
        <span class="n">prval</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">rest</span><span class="o">)</span> <span class="o">=</span> <span class="n">array_v_uncons</span><span class="o">(</span><span class="n">pf</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">result</span> <span class="o">=</span> <span class="n">loop</span><span class="o">(</span><span class="n">rest</span> <span class="o">|</span> <span class="n">ptr_add</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;(</span><span class="n">ptr</span><span class="o">,</span> <span class="mi">1</span><span class="o">),</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">acc</span> <span class="o">+</span> <span class="o">!</span><span class="n">ptr</span><span class="o">)</span>
        <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pf</span> <span class="o">:=</span> <span class="n">array_v_cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">rest</span><span class="o">)</span>
      <span class="k">in</span> <span class="n">result</span> <span class="k">end</span>
  <span class="k">in</span> <span class="n">loop</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="n">p</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="k">&#39;</span><span class="n">var&#39;</span> <span class="n">is</span> <span class="n">used</span> <span class="k">to</span> <span class="n">create</span> <span class="n">stack</span><span class="o">-</span><span class="n">allocated</span> <span class="o">(</span><span class="n">lvalue</span><span class="o">)</span> <span class="n">variables</span>
<span class="k">val</span> <span class="n">seven</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="k">let</span>
    <span class="n">var</span> <span class="n">res</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="o">//</span> <span class="n">they</span> <span class="n">can</span> <span class="n">be</span> <span class="n">modified</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">res</span> <span class="o">:=</span> <span class="n">res</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="o">//</span> <span class="n">addr</span><span class="o">@</span> <span class="n">res</span> <span class="n">is</span> <span class="n">a</span> <span class="n">pointer</span> <span class="k">to</span> <span class="n">it</span><span class="o">,</span> <span class="ow">and</span> <span class="n">view</span><span class="o">@</span> <span class="n">res</span> <span class="n">is</span> <span class="n">the</span> <span class="n">associated</span> <span class="n">proof</span>
    <span class="k">val</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="n">inc_three_times</span><span class="o">(</span><span class="n">view</span><span class="o">@</span> <span class="n">res</span> <span class="o">|</span> <span class="n">addr</span><span class="o">@</span> <span class="n">res</span><span class="o">)</span>
    <span class="o">//</span> <span class="n">need</span> <span class="k">to</span> <span class="n">give</span> <span class="n">back</span> <span class="n">the</span> <span class="n">view</span> <span class="n">before</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">goes</span> <span class="n">out</span> <span class="k">of</span> <span class="n">scope</span>
    <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">view</span><span class="o">@</span> <span class="n">res</span> <span class="o">:=</span> <span class="n">pf</span>
  <span class="k">in</span> <span class="n">res</span> <span class="k">end</span>

<span class="o">//</span> <span class="nc">References</span> <span class="k">let</span> <span class="n">you</span> <span class="n">pass</span> <span class="n">lvalues</span><span class="o">,</span> <span class="n">like</span> <span class="k">in</span> <span class="nc">C</span><span class="o">++</span>
<span class="n">fn</span> <span class="n">square</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">int</span><span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">//</span> <span class="n">they</span> <span class="n">can</span> <span class="n">be</span> <span class="n">modified</span>

<span class="k">val</span> <span class="n">sixteen</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="k">let</span>
    <span class="n">var</span> <span class="n">res</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">square</span> <span class="n">res</span>
  <span class="k">in</span> <span class="n">res</span> <span class="k">end</span>

<span class="n">fn</span> <span class="n">inc_at_ref</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">int</span><span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="o">//</span> <span class="n">like</span> <span class="n">vars</span><span class="o">,</span> <span class="n">references</span> <span class="n">have</span> <span class="n">views</span> <span class="ow">and</span> <span class="n">addresses</span>
    <span class="k">val</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="n">inc_at_ptr</span><span class="o">(</span><span class="n">view</span><span class="o">@</span> <span class="n">x</span> <span class="o">|</span> <span class="n">addr</span><span class="o">@</span> <span class="n">x</span><span class="o">)</span>
    <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">view</span><span class="o">@</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">pf</span>
  <span class="k">in</span> <span class="bp">()</span> <span class="k">end</span>

<span class="o">//</span> <span class="nc">Like</span> <span class="o">!</span> <span class="k">for</span> <span class="n">views</span><span class="o">,</span> <span class="o">&amp;</span> <span class="n">references</span> <span class="n">are</span> <span class="n">only</span> <span class="n">legal</span> <span class="k">as</span> <span class="n">argument</span> <span class="n">types</span>
<span class="o">//</span> <span class="n">fn</span> <span class="n">bad</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">int</span><span class="o">):</span> <span class="o">&amp;</span><span class="kt">int</span> <span class="o">=</span> <span class="n">x</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>

<span class="o">//</span> <span class="n">this</span> <span class="n">takes</span> <span class="n">a</span> <span class="n">proof</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">@</span> <span class="n">l</span><span class="o">,</span> <span class="n">but</span> <span class="n">returns</span> <span class="n">a</span> <span class="n">proof</span> <span class="kt">int</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">@</span> <span class="n">l</span>
<span class="o">//</span> <span class="n">since</span> <span class="n">they&#39;re</span> <span class="n">different</span> <span class="n">types</span><span class="o">,</span> <span class="n">we</span> <span class="n">can&#39;t</span> <span class="n">use</span> <span class="o">!</span><span class="kt">int</span> <span class="o">@</span> <span class="n">l</span> <span class="n">like</span> <span class="n">before</span>
<span class="n">fn</span> <span class="n">refined_inc_at_ptr</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span>
  <span class="n">pf</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">@</span> <span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span>
<span class="o">):</span> <span class="o">(</span><span class="kt">int</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">@</span> <span class="n">l</span> <span class="o">|</span> <span class="n">void</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!</span><span class="n">p</span> <span class="o">:=</span> <span class="o">!</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">in</span> <span class="o">(</span><span class="n">pf</span> <span class="o">|</span> <span class="bp">()</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">special</span> <span class="n">syntactic</span> <span class="n">sugar</span> <span class="k">for</span> <span class="n">returning</span> <span class="n">a</span> <span class="n">proof</span> <span class="n">at</span> <span class="n">a</span> <span class="n">different</span> <span class="k">type</span>
<span class="n">fn</span> <span class="n">refined_dec_at_ptr</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}</span> <span class="o">(</span>
  <span class="n">pf</span><span class="o">:</span> <span class="o">!</span><span class="kt">int</span> <span class="n">n</span> <span class="o">@</span> <span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="kt">int</span> <span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">@</span> <span class="n">l</span> <span class="o">|</span> <span class="n">p</span><span class="o">:</span> <span class="n">ptr</span> <span class="n">l</span>
<span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="o">!</span><span class="n">p</span> <span class="o">:=</span> <span class="o">!</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span>

<span class="o">//</span> <span class="n">legal</span> <span class="n">but</span> <span class="n">very</span> <span class="n">bad</span> <span class="n">code</span>
<span class="n">prfn</span> <span class="n">swap_proofs</span> <span class="o">{</span><span class="n">v1</span><span class="o">,</span><span class="n">v2</span><span class="o">:</span><span class="n">view</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span><span class="o">:</span> <span class="o">!</span><span class="n">v1</span> <span class="o">&gt;&gt;</span> <span class="n">v2</span><span class="o">,</span> <span class="n">b</span><span class="o">:</span> <span class="o">!</span><span class="n">v2</span> <span class="o">&gt;&gt;</span> <span class="n">v1</span><span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="n">prval</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">b</span>
    <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">tmp</span>
  <span class="k">in</span> <span class="bp">()</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">also</span> <span class="n">works</span> <span class="k">with</span> <span class="n">references</span>
<span class="n">fn</span> <span class="n">refined_square</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">int</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="kt">int</span> <span class="o">(</span><span class="n">n</span><span class="o">*</span><span class="n">n</span><span class="o">)):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">fn</span> <span class="n">replace</span> <span class="o">{</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">:</span><span class="n">vtype</span><span class="o">}</span> <span class="o">(</span><span class="n">dest</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="n">b</span><span class="o">,</span> <span class="n">src</span><span class="o">:</span> <span class="n">b</span><span class="o">):</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">val</span> <span class="n">old</span> <span class="o">=</span> <span class="n">dest</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">:=</span> <span class="n">src</span>
  <span class="k">in</span> <span class="n">old</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">values</span> <span class="n">can</span> <span class="n">be</span> <span class="n">uninitialized</span>
<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">write</span> <span class="o">(</span><span class="n">place</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">?</span> <span class="o">&gt;&gt;</span> <span class="n">a</span><span class="o">,</span> <span class="k">value</span><span class="o">:</span> <span class="n">a</span><span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="n">place</span> <span class="o">:=</span> <span class="k">value</span>

<span class="k">val</span> <span class="n">forty</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="k">let</span>
    <span class="n">var</span> <span class="n">res</span><span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">write</span> <span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="mi">40</span><span class="o">)</span>
  <span class="k">in</span> <span class="n">res</span> <span class="k">end</span>

<span class="o">//</span> <span class="n">viewtype</span><span class="o">:</span> <span class="n">a</span> <span class="n">view</span> <span class="ow">and</span> <span class="n">a</span> <span class="k">type</span>
<span class="n">viewtypedef</span> <span class="nc">MaybeNullPtr</span><span class="o">(</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">)</span> <span class="o">=</span> <span class="o">[</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">]</span> <span class="o">(</span><span class="nc">MaybeNull</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">l</span><span class="o">)</span> <span class="o">|</span> <span class="n">ptr</span> <span class="n">l</span><span class="o">)</span>
<span class="o">//</span> <span class="nc">MaybeNullPtr</span> <span class="n">has</span> <span class="k">type</span> <span class="k">&#39;</span><span class="n">viewtype&#39;</span> <span class="o">(</span><span class="n">aka</span> <span class="k">&#39;</span><span class="n">vtype&#39;</span><span class="o">)</span>
<span class="o">//</span> <span class="k">type</span> <span class="n">is</span> <span class="n">a</span> <span class="n">subtype</span> <span class="k">of</span> <span class="n">vtype</span> <span class="ow">and</span> <span class="n">t</span><span class="o">@</span><span class="n">ype</span> <span class="n">is</span> <span class="n">a</span> <span class="n">subtype</span> <span class="k">of</span> <span class="n">vt</span><span class="o">@</span><span class="n">ype</span>

<span class="o">//</span> <span class="nc">The</span> <span class="n">most</span> <span class="n">general</span> <span class="n">identity</span> <span class="k">function</span><span class="o">:</span>
<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">id7</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span>

<span class="o">//</span> <span class="n">since</span> <span class="n">they</span> <span class="n">contain</span> <span class="n">views</span><span class="o">,</span> <span class="n">viewtypes</span> <span class="n">must</span> <span class="n">be</span> <span class="n">used</span> <span class="n">linearly</span>
<span class="o">//</span> <span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">duplicate</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>
<span class="o">//</span> <span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="bp">()</span> <span class="o">//</span> <span class="n">doesn&#39;t</span> <span class="n">compile</span>

<span class="o">//</span> <span class="n">arrayptr</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">l</span><span class="o">,</span><span class="n">n</span><span class="o">)</span> <span class="n">is</span> <span class="n">a</span> <span class="n">convenient</span> <span class="n">built</span><span class="o">-</span><span class="k">in</span> <span class="n">viewtype</span>
<span class="n">fn</span> <span class="n">easier_sum_array</span> <span class="o">{</span><span class="n">l</span><span class="o">:</span><span class="n">addr</span><span class="o">}{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">p</span><span class="o">:</span> <span class="o">!</span><span class="n">arrayptr</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span><span class="n">l</span><span class="o">,</span><span class="n">n</span><span class="o">),</span> <span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">):</span> <span class="kt">int</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">fun</span> <span class="n">loop</span> <span class="o">{</span><span class="n">i</span><span class="o">:</span><span class="n">nat</span> <span class="o">|</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">}</span> <span class="o">(</span>
      <span class="n">p</span><span class="o">:</span> <span class="o">!</span><span class="n">arrayptr</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span><span class="n">l</span><span class="o">,</span><span class="n">n</span><span class="o">),</span> <span class="n">n</span><span class="o">:</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">:</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">acc</span><span class="o">:</span> <span class="kt">int</span>
    <span class="o">):</span> <span class="kt">int</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">then</span> <span class="n">acc</span>
      <span class="k">else</span> <span class="n">loop</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">p</span><span class="o">[</span><span class="n">i</span><span class="o">])</span>
  <span class="k">in</span> <span class="n">loop</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="k">end</span>


<span class="o">/***************</span> <span class="nc">Part</span> <span class="mi">5</span><span class="o">:</span> <span class="n">dataviewtypes</span> <span class="o">****************/</span>

<span class="o">//</span> <span class="n">a</span> <span class="n">dataviewtype</span> <span class="n">is</span> <span class="n">a</span> <span class="n">heap</span><span class="o">-</span><span class="n">allocated</span> <span class="n">non</span><span class="o">-</span><span class="n">shared</span> <span class="n">inductive</span> <span class="k">type</span>

<span class="o">//</span> <span class="k">in</span> <span class="n">the</span> <span class="n">stdlib</span><span class="o">:</span>
<span class="o">//</span> <span class="n">dataviewtype</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">,</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span>
<span class="o">//</span>   <span class="o">|</span> <span class="n">list_vt_nil</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
<span class="o">//</span>   <span class="o">|</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="n">list_vt_cons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="k">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">))</span>

<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">length</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="o">!</span><span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)):</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">let</span>                         <span class="o">//</span> <span class="o">^</span> <span class="n">since</span> <span class="n">we&#39;re</span> <span class="n">not</span> <span class="n">consuming</span> <span class="n">it</span>
    <span class="k">fun</span> <span class="n">loop</span> <span class="o">{</span><span class="n">acc</span><span class="o">:</span><span class="kt">int</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="o">!</span><span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">-</span><span class="n">acc</span><span class="o">),</span> <span class="n">acc</span><span class="o">:</span> <span class="kt">int</span> <span class="n">acc</span><span class="o">):</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span>
      <span class="n">case</span> <span class="n">l</span> <span class="k">of</span>
      <span class="o">|</span> <span class="n">list_vt_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="n">acc</span>
      <span class="o">|</span> <span class="n">list_vt_cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">loop</span><span class="o">(</span><span class="n">tail</span><span class="o">,</span> <span class="n">acc</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
  <span class="k">in</span> <span class="n">loop</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span>     <span class="n">vvvvv</span>  <span class="n">not</span> <span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">,</span> <span class="n">because</span> <span class="n">you</span> <span class="n">can&#39;t</span> <span class="n">easily</span> <span class="n">get</span> <span class="n">rid</span> <span class="k">of</span> <span class="n">a</span> <span class="n">vt</span><span class="o">@</span><span class="n">ype</span>
<span class="k">fun</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">destroy_list</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">n</span><span class="o">)):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="n">case</span> <span class="n">l</span> <span class="k">of</span>
  <span class="o">//</span> <span class="o">~</span> <span class="n">pattern</span> <span class="k">match</span> <span class="n">consumes</span> <span class="ow">and</span> <span class="n">frees</span> <span class="n">that</span> <span class="n">node</span>
  <span class="o">|</span> <span class="o">~</span><span class="n">list_vt_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="bp">()</span>
  <span class="o">|</span> <span class="o">~</span><span class="n">list_vt_cons</span><span class="o">(_,</span> <span class="n">tail</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">destroy_list</span> <span class="n">tail</span>

<span class="o">//</span> <span class="n">unlike</span> <span class="n">a</span> <span class="n">datatype</span><span class="o">,</span> <span class="n">a</span> <span class="n">dataviewtype</span> <span class="n">can</span> <span class="n">be</span> <span class="n">modified</span><span class="o">:</span>
<span class="k">fun</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">push_back</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span>
  <span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">,</span>
  <span class="n">l</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">n</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
<span class="o">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="n">case</span> <span class="n">l</span> <span class="k">of</span>
  <span class="o">|</span> <span class="o">~</span><span class="n">list_vt_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="n">l</span> <span class="o">:=</span> <span class="n">list_vt_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">list_vt_nil</span><span class="o">)</span>
  <span class="o">//</span> <span class="o">@</span> <span class="n">pattern</span> <span class="k">match</span> <span class="n">disassembles</span><span class="o">/</span><span class="s2">&quot;unfolds&quot;</span> <span class="n">the</span> <span class="n">datavtype&#39;s</span> <span class="n">view</span><span class="o">,</span> <span class="n">so</span> <span class="n">you</span> <span class="n">can</span>
  <span class="o">//</span> <span class="n">modify</span> <span class="n">its</span> <span class="n">components</span>
  <span class="o">|</span> <span class="o">@</span><span class="n">list_vt_cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="k">let</span>
      <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">push_back</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span>
      <span class="o">//</span> <span class="n">reassemble</span> <span class="n">it</span> <span class="k">with</span> <span class="n">fold</span><span class="o">@</span>
      <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">fold</span><span class="o">@</span> <span class="n">l</span>
    <span class="k">in</span> <span class="bp">()</span> <span class="k">end</span>

<span class="k">fun</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">pop_last</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">pos</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">n</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)):</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">val</span><span class="o">+</span> <span class="o">@</span><span class="n">list_vt_cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="o">=</span> <span class="n">l</span>
  <span class="k">in</span> <span class="n">case</span> <span class="n">tail</span> <span class="k">of</span>
    <span class="o">|</span> <span class="n">list_vt_cons</span> <span class="o">_</span> <span class="o">=&gt;</span> <span class="k">let</span>
        <span class="k">val</span> <span class="n">res</span> <span class="o">=</span> <span class="n">pop_last</span> <span class="n">tail</span>
        <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">fold</span><span class="o">@</span> <span class="n">l</span>
      <span class="k">in</span> <span class="n">res</span> <span class="k">end</span>
    <span class="o">|</span> <span class="o">~</span><span class="n">list_vt_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="k">let</span>
        <span class="k">val</span> <span class="n">head</span> <span class="o">=</span> <span class="n">head</span>
        <span class="o">//</span> <span class="nc">Deallocate</span> <span class="n">empty</span> <span class="n">datavtype</span> <span class="n">nodes</span> <span class="k">with</span> <span class="n">free</span><span class="o">@</span>
        <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">free</span><span class="o">@{..}{</span><span class="mi">0</span><span class="o">}</span> <span class="n">l</span>
        <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">l</span> <span class="o">:=</span> <span class="n">list_vt_nil</span><span class="bp">()</span>
      <span class="k">in</span> <span class="n">head</span> <span class="k">end</span>
 <span class="o">/**</span> <span class="nc">Equivalently</span><span class="o">:</span>
  <span class="o">*</span> <span class="o">|</span> <span class="o">~</span><span class="n">list_vt_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="k">let</span>
  <span class="o">*</span>     <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">fold</span><span class="o">@</span> <span class="n">l</span>
  <span class="o">*</span>     <span class="k">val</span><span class="o">+</span> <span class="o">~</span><span class="n">list_vt_cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="o">~</span><span class="n">list_vt_nil</span><span class="bp">()</span><span class="o">)</span> <span class="o">=</span> <span class="n">l</span>
  <span class="o">*</span>     <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">l</span> <span class="o">:=</span> <span class="n">list_vt_nil</span><span class="bp">()</span>
  <span class="o">*</span>   <span class="k">in</span> <span class="n">head</span> <span class="k">end</span>
  <span class="o">*/</span>
  <span class="k">end</span>

<span class="o">//</span> <span class="s2">&quot;holes&quot;</span> <span class="o">(</span><span class="n">ie</span> <span class="n">uninitialized</span> <span class="n">memory</span><span class="o">)</span> <span class="n">can</span> <span class="n">be</span> <span class="n">created</span> <span class="k">with</span> <span class="o">_</span> <span class="n">on</span> <span class="n">the</span> <span class="nc">RHS</span>
<span class="o">//</span> <span class="nc">This</span> <span class="k">function</span> <span class="n">uses</span> <span class="n">destination</span><span class="o">-</span><span class="n">passing</span><span class="o">-</span><span class="n">style</span> <span class="k">to</span> <span class="n">copy</span> <span class="n">the</span> <span class="kt">list</span> <span class="k">in</span> <span class="n">a</span> <span class="n">single</span>
<span class="o">//</span> <span class="n">tail</span><span class="o">-</span><span class="n">recursive</span> <span class="n">pass</span><span class="o">.</span>
<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">copy_list</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="o">!</span><span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)):</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="n">var</span> <span class="n">res</span><span class="o">:</span> <span class="n">ptr</span>
    <span class="k">fun</span> <span class="n">loop</span> <span class="o">{</span><span class="n">k</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="o">!</span><span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">k</span><span class="o">),</span> <span class="n">hole</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">?</span> <span class="o">&gt;&gt;</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">k</span><span class="o">)):</span> <span class="n">void</span> <span class="o">=</span>
      <span class="n">case</span> <span class="n">l</span> <span class="k">of</span>
      <span class="o">|</span> <span class="n">list_vt_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="n">hole</span> <span class="o">:=</span> <span class="n">list_vt_nil</span>
      <span class="o">|</span> <span class="n">list_vt_cons</span><span class="o">(</span><span class="n">first</span><span class="o">,</span> <span class="n">rest</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="k">let</span>
          <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">hole</span> <span class="o">:=</span> <span class="n">list_vt_cons</span><span class="o">{..}{</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="o">}(</span><span class="n">first</span><span class="o">,</span> <span class="o">_)</span>
          <span class="o">//</span>                                            <span class="o">^</span> <span class="n">on</span> <span class="nc">RHS</span><span class="o">:</span> <span class="n">a</span> <span class="n">hole</span>
          <span class="k">val</span><span class="o">+</span><span class="n">list_vt_cons</span><span class="o">(_,</span> <span class="n">new_hole</span><span class="o">)</span> <span class="o">=</span> <span class="n">hole</span>
          <span class="o">//</span>               <span class="o">^</span> <span class="n">on</span> <span class="nc">LHS</span><span class="o">:</span> <span class="n">wildcard</span> <span class="n">pattern</span> <span class="o">(</span><span class="n">not</span> <span class="n">a</span> <span class="n">hole</span><span class="o">)</span>
          <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">(</span><span class="n">rest</span><span class="o">,</span> <span class="n">new_hole</span><span class="o">)</span>
          <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">fold</span><span class="o">@</span> <span class="n">hole</span>
        <span class="k">in</span> <span class="bp">()</span> <span class="k">end</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">res</span><span class="o">)</span>
  <span class="k">in</span> <span class="n">res</span> <span class="k">end</span>

<span class="o">//</span> <span class="nc">Reverse</span> <span class="n">a</span> <span class="n">linked</span><span class="o">-</span><span class="kt">list</span> <span class="o">*</span><span class="k">in</span> <span class="n">place</span><span class="o">*</span> <span class="o">--</span> <span class="n">no</span> <span class="n">allocations</span> <span class="ow">or</span> <span class="n">frees</span>
<span class="n">fn</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">vt</span><span class="o">@</span><span class="n">ype</span><span class="o">}</span> <span class="n">in_place_reverse</span> <span class="o">{</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)):</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">fun</span> <span class="n">loop</span> <span class="o">{</span><span class="n">k</span><span class="o">:</span><span class="n">nat</span><span class="o">}</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="o">),</span> <span class="n">acc</span><span class="o">:</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">k</span><span class="o">)):</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">=</span>
      <span class="n">case</span> <span class="n">l</span> <span class="k">of</span>
      <span class="o">|</span> <span class="o">~</span><span class="n">list_vt_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="n">acc</span>
      <span class="o">|</span> <span class="o">@</span><span class="n">list_vt_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="k">let</span>
          <span class="k">val</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">replace</span><span class="o">(</span><span class="n">tail</span><span class="o">,</span> <span class="n">acc</span><span class="o">)</span>
          <span class="o">//</span> <span class="n">the</span> <span class="n">node</span> <span class="sc">&#39;l&#39;</span> <span class="n">is</span> <span class="n">now</span> <span class="n">part</span> <span class="k">of</span> <span class="n">acc</span> <span class="n">instead</span> <span class="k">of</span> <span class="n">the</span> <span class="n">original</span> <span class="kt">list</span>
          <span class="n">prval</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">fold</span><span class="o">@</span> <span class="n">l</span>
        <span class="k">in</span> <span class="n">loop</span> <span class="o">(</span><span class="n">rest</span><span class="o">,</span> <span class="n">l</span><span class="o">)</span> <span class="k">end</span>
  <span class="k">in</span> <span class="n">loop</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">list_vt_nil</span><span class="o">)</span> <span class="k">end</span>


<span class="o">/***************</span> <span class="nc">Part</span> <span class="mi">6</span><span class="o">:</span> <span class="n">miscellaneous</span> <span class="n">extras</span> <span class="o">****************/</span>

<span class="o">//</span> <span class="n">a</span> <span class="n">record</span>
<span class="o">//</span> <span class="nc">Point</span> <span class="n">has</span> <span class="k">type</span> <span class="k">&#39;</span><span class="n">t</span><span class="o">@</span><span class="n">ype&#39;</span>
<span class="n">typedef</span> <span class="nc">Point</span> <span class="o">=</span> <span class="o">@{</span> <span class="n">x</span><span class="o">=</span> <span class="kt">int</span><span class="o">,</span> <span class="n">y</span><span class="o">=</span> <span class="kt">int</span> <span class="o">}</span>
<span class="k">val</span> <span class="n">origin</span><span class="o">:</span> <span class="nc">Point</span> <span class="o">=</span> <span class="o">@{</span> <span class="n">x</span><span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">y</span><span class="o">=</span> <span class="mi">0</span> <span class="o">}</span>

<span class="o">//</span> <span class="n">tuples</span> <span class="ow">and</span> <span class="n">records</span> <span class="n">are</span> <span class="n">normally</span> <span class="n">unboxed</span><span class="o">,</span> <span class="n">but</span> <span class="n">there</span> <span class="n">are</span> <span class="n">boxed</span> <span class="n">variants</span>
<span class="o">//</span> <span class="nc">BoxedPoint</span> <span class="n">has</span> <span class="k">type</span> <span class="k">&#39;type&#39;</span>
<span class="n">typedef</span> <span class="nc">BoxedPoint</span> <span class="o">=</span> <span class="k">&#39;</span><span class="o">{</span> <span class="n">x</span><span class="o">=</span> <span class="kt">int</span><span class="o">,</span> <span class="n">y</span><span class="o">=</span> <span class="kt">int</span> <span class="o">}</span>
<span class="k">val</span> <span class="n">boxed_pair</span><span class="o">:</span> <span class="k">&#39;</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span><span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="k">&#39;</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>

<span class="o">//</span> <span class="nc">When</span> <span class="n">passing</span> <span class="n">a</span> <span class="n">pair</span> <span class="k">as</span> <span class="n">the</span> <span class="n">single</span> <span class="n">argument</span> <span class="k">to</span> <span class="n">a</span> <span class="k">function</span><span class="o">,</span> <span class="n">it</span> <span class="n">needs</span> <span class="k">to</span> <span class="n">be</span>
<span class="o">//</span> <span class="n">written</span> <span class="o">@(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">to</span> <span class="n">avoid</span> <span class="n">ambiguity</span> <span class="k">with</span> <span class="n">multi</span><span class="o">-</span><span class="n">argument</span> <span class="n">functions</span>
<span class="k">val</span> <span class="n">six_plus_seven</span> <span class="o">=</span> <span class="k">let</span>
    <span class="k">fun</span> <span class="n">sum_of_pair</span> <span class="o">(</span><span class="n">pair</span><span class="o">:</span> <span class="o">(</span><span class="kt">int</span><span class="o">,</span><span class="kt">int</span><span class="o">))</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="mi">0</span> <span class="o">+</span> <span class="n">pair</span><span class="o">.</span><span class="mi">1</span>
  <span class="k">in</span> <span class="n">sum_of_pair</span> <span class="o">@(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">)</span> <span class="k">end</span>

<span class="o">//</span> <span class="nc">When</span> <span class="n">a</span> <span class="n">constructor</span> <span class="n">has</span> <span class="n">no</span> <span class="n">associated</span> <span class="n">data</span><span class="o">,</span> <span class="n">such</span> <span class="k">as</span> <span class="nc">None</span><span class="bp">()</span><span class="o">,</span> <span class="n">the</span> <span class="n">parentheses</span>
<span class="o">//</span> <span class="n">are</span> <span class="n">optional</span> <span class="k">in</span> <span class="n">expressions</span><span class="o">.</span>  <span class="nc">However</span><span class="o">,</span> <span class="n">they</span> <span class="n">are</span> <span class="n">mandatory</span> <span class="k">in</span> <span class="n">patterns</span>
<span class="n">fn</span> <span class="n">inc_option</span> <span class="o">(</span><span class="n">opt</span><span class="o">:</span> <span class="nc">Option</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">case</span> <span class="n">opt</span> <span class="k">of</span>
  <span class="o">|</span> <span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">None</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="nc">None</span>

<span class="o">//</span> <span class="nc">ATS</span> <span class="n">has</span> <span class="n">a</span> <span class="n">simple</span> <span class="nc">FFI</span><span class="o">,</span> <span class="n">since</span> <span class="n">it</span> <span class="n">compiles</span> <span class="k">to</span> <span class="nc">C</span> <span class="ow">and</span> <span class="o">(</span><span class="n">mostly</span><span class="o">)</span> <span class="n">uses</span> <span class="n">the</span> <span class="nc">C</span> <span class="nc">ABI</span>
<span class="o">%{</span>
<span class="o">//</span> <span class="nc">Inline</span> <span class="nc">C</span> <span class="n">code</span>
<span class="kt">int</span> <span class="n">scanf_wrapper</span><span class="o">(</span><span class="n">void</span> <span class="o">*</span><span class="n">format</span><span class="o">,</span> <span class="n">void</span> <span class="o">*</span><span class="k">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">return</span> <span class="n">scanf</span><span class="o">((</span><span class="kt">char</span> <span class="o">*)</span> <span class="n">format</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span> <span class="o">*)</span> <span class="k">value</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">%}</span>
<span class="o">//</span> <span class="nc">If</span> <span class="n">you</span> <span class="n">wanted</span> <span class="k">to</span><span class="o">,</span> <span class="n">you</span> <span class="n">could</span> <span class="n">define</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">dataviewtype</span> <span class="n">more</span> <span class="n">accurately</span>
<span class="o">//</span> <span class="n">describing</span> <span class="n">the</span> <span class="n">result</span> <span class="k">of</span> <span class="n">scanf</span>
<span class="n">extern</span> <span class="n">fn</span> <span class="n">scanf</span> <span class="o">(</span><span class="n">format</span><span class="o">:</span> <span class="kt">string</span><span class="o">,</span> <span class="k">value</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">int</span><span class="o">):</span> <span class="kt">int</span> <span class="o">=</span> <span class="s2">&quot;scanf_wrapper&quot;</span>

<span class="n">fn</span> <span class="n">get_input_number</span> <span class="bp">()</span><span class="o">:</span> <span class="nc">Option</span> <span class="kt">int</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="n">var</span> <span class="n">x</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">in</span>
    <span class="k">if</span> <span class="n">scanf</span><span class="o">(</span><span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">then</span> <span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
    <span class="k">else</span> <span class="nc">None</span>
  <span class="k">end</span>

<span class="o">//</span> <span class="n">extern</span> <span class="n">is</span> <span class="n">also</span> <span class="n">used</span> <span class="k">for</span> <span class="n">separate</span> <span class="n">declarations</span> <span class="ow">and</span> <span class="n">definitions</span>
<span class="n">extern</span> <span class="n">fn</span> <span class="n">say_hi</span> <span class="bp">()</span><span class="o">:</span> <span class="n">void</span>
<span class="o">//</span> <span class="n">later</span> <span class="n">on</span><span class="o">,</span> <span class="ow">or</span> <span class="k">in</span> <span class="n">another</span> <span class="n">file</span><span class="o">:</span>
<span class="n">implement</span> <span class="n">say_hi</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print</span> <span class="s2">&quot;hi</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="o">//</span> <span class="k">if</span> <span class="n">you</span> <span class="n">implement</span> <span class="n">main0</span><span class="o">,</span> <span class="n">it</span> <span class="n">will</span> <span class="n">run</span> <span class="k">as</span> <span class="n">the</span> <span class="n">main</span> <span class="k">function</span>
<span class="o">//</span> <span class="n">implmnt</span> <span class="n">is</span> <span class="n">an</span> <span class="n">alias</span> <span class="k">for</span> <span class="n">implement</span>
<span class="n">implmnt</span> <span class="n">main0</span> <span class="bp">()</span> <span class="o">=</span> <span class="bp">()</span>

<span class="o">//</span> <span class="k">as</span> <span class="n">well</span> <span class="k">as</span> <span class="k">for</span> <span class="n">axioms</span><span class="o">:</span>
<span class="n">extern</span> <span class="n">praxi</span> <span class="n">view_id</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">view</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">):</span> <span class="n">a</span>
<span class="o">//</span> <span class="n">you</span> <span class="n">don&#39;t</span> <span class="n">need</span> <span class="k">to</span> <span class="n">actually</span> <span class="n">implement</span> <span class="n">the</span> <span class="n">axioms</span><span class="o">,</span> <span class="n">but</span> <span class="n">you</span> <span class="n">could</span>
<span class="n">primplmnt</span> <span class="n">view_id</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
<span class="o">//</span> <span class="n">primplmnt</span> <span class="n">is</span> <span class="n">an</span> <span class="n">alias</span> <span class="k">for</span> <span class="n">primplement</span>

<span class="o">//</span> <span class="nc">Some</span> <span class="n">standard</span> <span class="n">aliases</span> <span class="n">are</span><span class="o">:</span>
<span class="o">//</span> <span class="nc">List0</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="o">[</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">]</span> <span class="kt">list</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">n</span><span class="o">)</span> <span class="ow">and</span> <span class="nc">List0_vt</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="o">[</span><span class="n">n</span><span class="o">:</span><span class="n">nat</span><span class="o">]</span> <span class="n">list_vt</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">n</span><span class="o">)</span>
<span class="o">//</span> <span class="n">t0p</span> <span class="o">=</span> <span class="n">t</span><span class="o">@</span><span class="n">ype</span> <span class="ow">and</span> <span class="n">vt0p</span> <span class="o">=</span> <span class="n">vt</span><span class="o">@</span><span class="n">ype</span>
<span class="k">fun</span> <span class="o">{</span><span class="n">a</span><span class="o">:</span><span class="n">t0p</span><span class="o">}</span> <span class="n">append</span> <span class="o">(</span><span class="n">xs</span><span class="o">:</span> <span class="nc">List0</span> <span class="n">a</span><span class="o">,</span> <span class="n">ys</span><span class="o">:</span> <span class="nc">List0</span> <span class="n">a</span><span class="o">):</span> <span class="nc">List0</span> <span class="n">a</span> <span class="o">=</span>
  <span class="n">case</span> <span class="n">xs</span> <span class="k">of</span>
  <span class="o">|</span> <span class="n">list_nil</span><span class="bp">()</span> <span class="o">=&gt;</span> <span class="n">ys</span>
  <span class="o">|</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">xs</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">list_cons</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">append</span><span class="o">(</span><span class="n">xs</span><span class="o">,</span> <span class="n">ys</span><span class="o">))</span>

<span class="o">//</span> <span class="n">there</span> <span class="n">are</span> <span class="n">many</span> <span class="n">ways</span> <span class="k">of</span> <span class="n">doing</span> <span class="n">things</span> <span class="n">after</span> <span class="n">one</span> <span class="n">another</span>
<span class="k">val</span> <span class="n">let_in_example</span> <span class="o">=</span> <span class="k">let</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print</span> <span class="s2">&quot;thing one</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">val</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print</span> <span class="s2">&quot;thing two</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="k">in</span> <span class="bp">()</span> <span class="k">end</span>

<span class="k">val</span> <span class="n">parens_example</span> <span class="o">=</span> <span class="o">(</span><span class="n">print</span> <span class="s2">&quot;thing one</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span> <span class="n">print</span> <span class="s2">&quot;thing two</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">begin_end_example</span> <span class="o">=</span> <span class="k">begin</span>
    <span class="n">print</span> <span class="s2">&quot;thing one</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
    <span class="n">print</span> <span class="s2">&quot;thing two</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span> <span class="o">//</span> <span class="n">optional</span> <span class="n">trailing</span> <span class="n">semicolon</span>
  <span class="k">end</span>

<span class="o">//</span> <span class="ow">and</span> <span class="n">many</span> <span class="n">ways</span> <span class="k">to</span> <span class="n">use</span> <span class="n">local</span> <span class="n">variables</span>
<span class="k">fun</span> <span class="n">times_four_let</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="k">fun</span> <span class="n">times_two</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
  <span class="k">in</span> <span class="n">times_two</span> <span class="o">(</span><span class="n">times_two</span> <span class="n">x</span><span class="o">)</span> <span class="k">end</span>

<span class="n">local</span>
  <span class="k">fun</span> <span class="n">times_two</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
<span class="k">in</span>
  <span class="k">fun</span> <span class="n">times_four_local</span> <span class="n">x</span> <span class="o">=</span> <span class="n">times_two</span> <span class="o">(</span><span class="n">times_two</span> <span class="n">x</span><span class="o">)</span>
<span class="k">end</span>

<span class="k">fun</span> <span class="n">times_four_where</span> <span class="n">x</span> <span class="o">=</span> <span class="n">times_two</span> <span class="o">(</span><span class="n">times_two</span> <span class="n">x</span><span class="o">)</span>
  <span class="n">where</span> <span class="o">{</span>
    <span class="k">fun</span> <span class="n">times_two</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
  <span class="o">}</span>

<span class="o">////</span> <span class="nc">The</span> <span class="n">last</span> <span class="n">kind</span> <span class="k">of</span> <span class="n">comment</span> <span class="k">in</span> <span class="nc">ATS</span> <span class="n">is</span> <span class="n">an</span> <span class="k">end</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">file</span> <span class="n">comment</span><span class="o">.</span>

<span class="nc">Anything</span> <span class="n">between</span> <span class="n">the</span> <span class="n">four</span> <span class="n">slashes</span> <span class="ow">and</span> <span class="n">the</span> <span class="k">end</span> <span class="k">of</span> <span class="n">the</span> <span class="n">file</span> <span class="n">is</span> <span class="n">ignored</span><span class="o">.</span>

<span class="nc">Have</span> <span class="k">fun</span> <span class="k">with</span> <span class="nc">ATS</span><span class="o">!</span>
</pre></div>
<h2>Learn more</h2>

<p>This isn&rsquo;t all there is to ATS &ndash; notably, some core features like closures and
the effect system are left out, as well as other less type-y stuff like modules
and the build system.  If you&rsquo;d like to write these sections yourself,
contributions would be welcome!</p>

<p>To learn more about ATS, visit the <a href="http://www.ats-lang.org/">ATS website</a>, in
particular the <a href="http://www.ats-lang.org/Documents.html">documentation page</a>.</p>

    <hr>
    <p>Got a suggestion? A correction, perhaps? <a href="https://github.com/adambard/learnxinyminutes-docs/issues/new">Open an Issue</a> on the Github Repo, or make a <a href="https://github.com/adambard/learnxinyminutes-docs/edit/master/ATS.html.markdown">pull request</a> yourself!
    </p>
    <p class="contributed">
    Originally contributed by Mark Barbone, and updated by <a href="https://github.com/adambard/learnxinyminutes-docs/blame/master/ATS.html.markdown">1 contributor(s)</a>.
    </p>

    <footer>
    <a style="float: left" rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a>
    <p>
    &copy; 2024
        <a href="https://github.com/mb64">Mark Barbone</a>
    </p>

    <p>

    </footer>
  </div>

        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script src="/js/script.js"></script>
    </body>
</html>
