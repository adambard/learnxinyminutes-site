<!DOCTYPE html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WXC8R75DEN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-WXC8R75DEN');
    </script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Language" content="en">
    <title>Learn Ansible in Y Minutes</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto+Slab:wght@100..900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/screen.css">
    <link rel="stylesheet" href="/css/light.css">
    <link rel="stylesheet" href="/css/dark.css">

    <link rel="canonical" href="https://learnxinyminutes.com/ansible/">
    <script>
      localStorage.removeItem("lxiym_theme");
    </script>
  </head>
  <body>
    <div class="container">
      <h1><a href="/">Learn X in Y minutes</a></h1>
      <h2>Where X=Ansible</h2>

      <p class="filelink">
        Get the code:
        <a href="/files/LearnAnsible.txt">LearnAnsible.txt</a>
      </p>
      <div id="doc">
<h2>Introduction</h2>
<div class="highlight"><pre lang="yaml"><span class="nn">---</span>
<span class="s">&quot;{{</span><span class="nv"> </span><span class="s">Ansible</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">is an orchestration tool written in Python.</span>
<span class="nn">...</span>
</pre></div>
<p>Ansible is (one of many) orchestration tools. It allows you to control your
environment (infrastructure and code) and automate the manual tasks.</p>
<p>Ansible has great integration with multiple operating systems (even Windows)
and some hardware (switches, Firewalls, etc). It has multiple tools that
integrate with the cloud providers. Almost every noteworthy cloud provider is
present in the ecosystem (AWS, Azure, Google, DigitalOcean, OVH, etc...).</p>
<p>But ansible is way more! It provides execution plans, an API, library, and callbacks.</p>
<h3>Main pros and cons</h3>
<h4>Pros</h4>
<ul>
<li>It is an agent-less tool. In most scenarios, it uses ssh as a transport layer.
In some way you can use it as 'bash on steroids'.</li>
<li>It is very easy to start. If you are familiar with the concept of ssh - you already
know Ansible (ALMOST).</li>
<li>It executes 'as is' - other tools (salt, puppet, chef - might execute in
different scenario than you would expect)</li>
<li>Documentation is at the world-class standard!</li>
<li>Writing your own modules and extensions is fairly easy.</li>
<li>Ansible AWX is the open source version of Ansible Tower we have been waiting
for, which provides an excellent UI.</li>
</ul>
<h4>Cons</h4>
<ul>
<li>It is an agent-less tool - every agent consumes up to 16MB ram - in some
environments, it may be noticeable amount.</li>
<li>It is agent-less - you have to verify your environment consistency
'on-demand' - there is no built-in mechanism that would warn you about some
change automatically (this can be achieved with reasonable effort)</li>
<li>Official GUI - Ansible Tower - is great but expensive.</li>
<li>There is no 'small enterprise' payment plan, however Ansible AWX is the free
open source version we were all waiting for.</li>
</ul>
<h4>Neutral</h4>
<p>Migration - Ansible &lt;-&gt; Salt is fairly easy - so if you would need an
event-driven agent environment - it would be a good choice to start quick with
Ansible, and convert to Salt when needed.</p>
<h4>Some concepts</h4>
<p>Ansible uses ssh or paramiko as a transport layer. In a way you can imagine
that you are using a ssh with API to perform your action. The simplest way is
to execute remote command in more controlled way (still using ssh).
On the other hand - in advanced scope - you can wrap Ansible (use python Ansible
code as a library) with your own Python scripts! It would act a
bit like Fabric then.</p>
<h2>Example</h2>
<p>An example playbook to install apache and configure log level</p>
<div class="highlight"><pre lang="yaml"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>

<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">      </span><span class="nt">apache2_log_level</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warn&quot;</span>

<span class="w">  </span><span class="nt">handlers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restart apache</span>
<span class="w">    </span><span class="nt">service</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache2</span>
<span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">    </span><span class="nt">notify</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wait for instances to listen on port 80</span>
<span class="w">    </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reload apache</span>
<span class="w">    </span><span class="nt">service</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache2</span>
<span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reloaded</span>
<span class="w">    </span><span class="nt">notify</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wait for instances to listen on port 80</span>
<span class="w">    </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wait for instances to listen on port 80</span>
<span class="w">    </span><span class="nt">wait_for</span><span class="p">:</span>
<span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<span class="w">      </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Update cache</span>
<span class="w">    </span><span class="nt">apt</span><span class="p">:</span>
<span class="w">      </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<span class="w">      </span><span class="nt">cache_valid_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7200</span>
<span class="w">    </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install packages</span>
<span class="w">    </span><span class="nt">apt</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">name={{ item }}</span>
<span class="w">    </span><span class="nt">with_items</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logrotate</span>
<span class="w">    </span><span class="nt">notify</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restart apache</span>
<span class="w">    </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure apache2 log level</span>
<span class="w">    </span><span class="nt">lineinfile</span><span class="p">:</span>
<span class="w">      </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/apache2/apache2.conf</span>
<span class="w">      </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LogLevel</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">apache2_log_level</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^LogLevel&quot;</span>
<span class="w">    </span><span class="nt">notify</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reload apache</span>
<span class="w">    </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="nn">...</span>
</pre></div>
<h2>Installation</h2>
<div class="highlight"><pre lang="bash"><span class="c1"># Universal way</span>
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>ansible

<span class="c1"># Debian, Ubuntu</span>
$<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>ansible
</pre></div>
<ul>
<li><a href="#infrastructure-as-a-code">Appendix A - How do I install ansible</a></li>
<li><a href="http://docs.ansible.com/ansible/latest/intro_installation.html">Additional Reading.</a></li>
</ul>
<h3>Your first ansible command (shell execution)</h3>
<div class="highlight"><pre lang="bash"><span class="c1"># Command pings localhost (defined in default inventory: /etc/ansible/hosts)</span>
$<span class="w"> </span>ansible<span class="w"> </span>-m<span class="w"> </span>ping<span class="w"> </span>localhost
<span class="c1"># You should see this output</span>
localhost<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,
<span class="w">    </span><span class="s2">&quot;ping&quot;</span>:<span class="w"> </span><span class="s2">&quot;pong&quot;</span>
<span class="o">}</span>
</pre></div>
<h3>Shell Commands</h3>
<p>There are few commands you should know about</p>
<ul>
<li><code>ansible</code> (to run modules in CLI)</li>
<li><code>ansible-playbook</code> (to run playbooks)</li>
<li><code>ansible-vault</code> (to manage secrets)</li>
<li><code>ansible-galaxy</code> (to install roles from github/galaxy)</li>
</ul>
<h3>Module</h3>
<p>A program (usually python) that executes, does some work and returns proper
JSON output. This program performs specialized task/action (like manage
instances in the cloud, execute shell command). The simplest module is called
<code>ping</code> - it just returns a JSON with <code>pong</code> message.</p>
<p>Example of modules:</p>
<ul>
<li>Module: <code>ping</code> - the simplest module that is useful to verify host connectivity</li>
<li>Module: <code>shell</code> - a module that executes a shell command on a specified host(s).</li>
</ul>
<div class="highlight"><pre lang="bash">$<span class="w"> </span>ansible<span class="w"> </span>-m<span class="w"> </span>ping<span class="w"> </span>all
$<span class="w"> </span>ansible<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;date; whoami&#39;</span><span class="w"> </span>localhost<span class="w"> </span><span class="c1">#hostname_or_a_group_name</span>
</pre></div>
<ul>
<li>Module: <code>command</code> - executes a single command that will not be processed
through the shell, so variables like <code>$HOME</code> or operands like <code>|` `;</code> will not
work. The command module is more secure, because it will not be affected by the
user’s environment. For more complex commands - use shell module.</li>
</ul>
<div class="highlight"><pre lang="bash">$<span class="w"> </span>ansible<span class="w"> </span>-m<span class="w"> </span><span class="nb">command</span><span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;date; whoami&#39;</span><span class="w"> </span><span class="c1"># FAILURE</span>
$<span class="w"> </span>ansible<span class="w"> </span>-m<span class="w"> </span><span class="nb">command</span><span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;date&#39;</span><span class="w"> </span>all
$<span class="w"> </span>ansible<span class="w"> </span>-m<span class="w"> </span><span class="nb">command</span><span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;whoami&#39;</span><span class="w"> </span>all
</pre></div>
<ul>
<li>Module: <code>file</code> - performs file operations (stat, link, dir, ...)</li>
<li>Module: <code>raw</code> - executes a low-down and dirty SSH command, not going through
the module subsystem (useful to install python2.7)</li>
</ul>
<h3>Task</h3>
<p>Execution of a single Ansible <strong>module</strong> is called a <strong>task</strong>. The simplest
module is called <code>ping</code> as you could see above.</p>
<p>Another example of the module that allows you to execute a command remotely on
multiple resources is called <code>shell</code>. See above how you were using them already.</p>
<h3>Playbook</h3>
<p><strong>Execution plan</strong> written in a form of script file(s) is called <strong>playbook</strong>.
Playbooks consist of multiple elements -</p>
<ul>
<li>a list (or group) of hosts that 'the play' is executed against</li>
<li><code>task(s)</code> or <code>role(s)</code> that are going to be executed</li>
<li>multiple optional settings (like default variables, and way more)</li>
</ul>
<p>Playbook script language is YAML. You can think that playbook is very advanced
CLI script that you are executing.</p>
<h4>Example of the playbook</h4>
<p>This example-playbook would execute (on all hosts defined in inventory) two tasks:</p>
<ul>
<li><code>ping</code> that would return message <em>pong</em></li>
<li><code>shell</code> that execute three commands and return the output to our terminal</li>
</ul>
<div class="highlight"><pre lang="yaml"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ping</span><span class="nv"> </span><span class="s">all&quot;</span>
<span class="w">      </span><span class="nt">ping</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;execute</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">shell</span><span class="nv"> </span><span class="s">command&quot;</span>
<span class="w">      </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;date;</span><span class="nv"> </span><span class="s">whoami;</span><span class="nv"> </span><span class="s">df</span><span class="nv"> </span><span class="s">-h;&quot;</span>
</pre></div>
<p>Run the playbook with the command:</p>
<div class="highlight"><pre lang="bash">$<span class="w"> </span>ansible-playbook<span class="w"> </span>path/name_of_the_playbook.yml
</pre></div>
<p>Note: Example playbook is explained in the next chapter: 'Roles'</p>
<h3>More on ansible concept</h3>
<h3>Inventory</h3>
<p>An inventory is a set of objects or hosts, against which we are executing our
playbooks or single tasks via shell commands. For these few minutes, let's
assume that we are using the default ansible inventory (which in Debian based
system is placed in <code>/etc/ansible/hosts</code>).</p>
<div class="highlight"><pre>localhost

[some_group]
hostA.mydomain.com
hostB.localdomain
1.2.3.4

[a_group_of_a_groups:children]
some_group
some_other_group
</pre></div>
<ul>
<li><a href="http://docs.ansible.com/ansible/latest/intro_inventory.html">Additional Reading.</a></li>
</ul>
<h3>ansible-roles (a 'template-playbooks' with right structure)</h3>
<p>You already know that the tasks (modules) can be run via CLI. You also know the
playbooks - the execution plans of multiple tasks (with variables and logic).</p>
<p>A concept called <code>role</code> was introduced for parts of the code (playbooks) that
should be reusable.</p>
<p><strong>Role</strong> is a structured way to manage your set of tasks, variables, handlers,
default settings, and way more (meta, files, templates). Roles allow reusing
the same parts of code in multiple playbooks (you can parametrize the role
'further' during its execution). Its a great way to introduce <code>object oriented</code>
management for your applications.</p>
<p>Role can be included in your playbook (executed via your playbook).</p>
<div class="highlight"><pre lang="yaml"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>

<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ping</span><span class="nv"> </span><span class="s">all&quot;</span>
<span class="w">        </span><span class="nt">ping</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;execute</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">shell</span><span class="nv"> </span><span class="s">command&quot;</span>
<span class="w">        </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;date;</span><span class="nv"> </span><span class="s">whoami;</span><span class="nv"> </span><span class="s">df</span><span class="nv"> </span><span class="s">-h;&quot;</span>

<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">some_role</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">another_role</span><span class="p p-Indicator">,</span><span class="nt"> some_variable</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;learnxiny&#39;</span><span class="p p-Indicator">,</span><span class="nt"> tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;my_tag&#39;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="p p-Indicator">}</span>

<span class="w">  </span><span class="nt">pre_tasks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">some pre-task</span>
<span class="w">        </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &#39;this task is the last, but would be executed before roles, and before tasks&#39;</span>
</pre></div>
<h4>For remaining examples we would use additional repository</h4>
<p>This example installs ansible in <code>virtualenv</code> so it is independent from the system.
You need to initialize it into your shell-context with the <code>source environment.sh</code>
command.</p>
<p>We are going to use this repository with examples: <a href="https://github.com/sirkubax/ansible-for-learnXinYminutes">https://github.com/sirkubax/ansible-for-learnXinYminutes</a></p>
<div class="highlight"><pre lang="bash">$<span class="w"> </span><span class="c1"># The following example contains a shell-prompt to indicate the venv and relative path</span>
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:sirkubax/ansible-for-learnXinYminutes.git
user@host:~/$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>ansible-for-learnXinYminutes
user@host:~/ansible-for-learnXinYminutes$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>environment.sh
$
$<span class="w"> </span><span class="c1"># First lets execute the simple_playbook.yml</span>
<span class="o">(</span>venv<span class="o">)</span><span class="w"> </span>user@host:~/ansible-for-learnXinYminutes$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/simple_playbook.yml
</pre></div>
<p>Run the playbook with roles example</p>
<div class="highlight"><pre lang="bash">$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>environment.sh
$<span class="w"> </span><span class="c1"># Now we would run the above playbook with roles</span>
<span class="o">(</span>venv<span class="o">)</span><span class="w"> </span>user@host:~/ansible-for-learnXinYminutes$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/simple_role.yml
</pre></div>
<h4>Role directory structure</h4>
<div class="highlight"><pre>roles/
   some_role/
     defaults/      # contains default variables
     files/         # for static files
     templates/     # for jinja templates
     tasks/         # tasks
     handlers/      # handlers
     vars/          # more variables (higher priority)
     meta/          # meta - package (role) info
</pre></div>
<h4>Role Handlers</h4>
<p>Handlers are tasks that can be triggered (notified) during execution of a
playbook, but they execute at the very end of a playbook. It is the best way to
restart a service, check if the application port is active (successful
deployment criteria), etc.</p>
<p>Get familiar with how you can use roles in the simple_apache_role example</p>
<div class="highlight"><pre>playbooks/roles/simple_apache_role/
├── tasks
│   └── main.yml
└── templates
    └── main.yml
</pre></div>
<h3>ansible - variables</h3>
<p>Ansible is flexible - it has 21 levels of variable precedence.
<a href="http://docs.ansible.com/ansible/latest/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">read more</a>
For now you should know that CLI variables have the top priority.
You should also know, that a nice way to pool some data is a <strong>lookup</strong></p>
<h3>Lookups</h3>
<p>Awesome tool to query data from various sources!!! Awesome!
query from:</p>
<ul>
<li>pipe  (load shell command output into variable!)</li>
<li>file</li>
<li>stream</li>
<li>etcd</li>
<li>password management tools</li>
<li>url</li>
</ul>
<div class="highlight"><pre lang="bash"><span class="c1"># read playbooks/lookup.yml</span>
<span class="c1"># then run</span>
<span class="o">(</span>venv<span class="o">)</span><span class="w"> </span>user@host:~/ansible-for-learnXinYminutes$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/lookup.yml
</pre></div>
<p>You can use them in CLI too</p>
<div class="highlight"><pre lang="yaml"><span class="l l-Scalar l-Scalar-Plain">ansible -m shell -a &#39;echo &quot;{{ my_variable }}&quot;&#39; -e &#39;my_variable=&quot;{{ lookup(&quot;pipe&quot;, &quot;date&quot;) }}&quot;&#39; localhost</span>
<span class="l l-Scalar l-Scalar-Plain">ansible -m shell -a &#39;echo &quot;{{ my_variable }}&quot;&#39; -e &#39;my_variable=&quot;{{ lookup(&quot;pipe&quot;, &quot;hostname&quot;) }}&quot;&#39; all</span>

<span class="l l-Scalar l-Scalar-Plain"># Or use in playbook</span>

<span class="l l-Scalar l-Scalar-Plain">(venv) user@host:~/ansible-for-learnXinYminutes$ ansible-playbook playbooks/lookup.yml</span>
</pre></div>
<h3>Register and Conditional</h3>
<h4>Register</h4>
<p>Another way to dynamically generate the variable content is the <code>register</code> command.
<code>Register</code> is also useful to store an output of a task and use its value
for executing further tasks.</p>
<div class="highlight"><pre>(venv) user@host:~/ansible-for-learnXinYminutes$ ansible-playbook playbooks/register_and_when.yml
</pre></div>
<div class="highlight"><pre lang="yaml"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check the system capacity</span>
<span class="w">     </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">df -h /</span>
<span class="w">     </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root_size</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debug root_size</span>
<span class="w">     </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">root_size</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debug root_size return code</span>
<span class="w">     </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">       </span><span class="nt">msg</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">root_size.rc</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="c1"># when: example</span>

<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Print this message when return code of &#39;check the system capacity&#39; was ok</span>
<span class="w">     </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">       </span><span class="nt">msg</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">root_size.rc</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">     </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root_size.rc == 0</span>
<span class="nn">...</span>
</pre></div>
<h4>Conditionals - when:</h4>
<p>You can define complex logic with Ansible and Jinja functions. Most common is
usage of <code>when:</code>, with some variable (often dynamically generated in previous
playbook steps with <code>register</code> or <code>lookup</code>)</p>
<div class="highlight"><pre lang="yaml"><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check the system capacity</span>
<span class="w">     </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">df -h /</span>
<span class="w">     </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">some_variable in &#39;a string&#39;</span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">mid_nagios_probe</span><span class="p p-Indicator">,</span><span class="nt"> when</span><span class="p">:</span><span class="w"> </span><span class="nv">allow_nagios_probes</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="nn">...</span>
</pre></div>
<h3>ansible - tags, limit</h3>
<p>You should know about a way to increase efficiency by this simple functionality</p>
<h4>TAGS</h4>
<p>You can tag a task, role (and its tasks), include, etc, and then run only the
tagged resources</p>
<div class="highlight"><pre>ansible-playbook playbooks/simple_playbook.yml --tags=tagA,tag_other
ansible-playbook playbooks/simple_playbook.yml -t tagA,tag_other

There are special tags:
    always

--skip-tags can be used to exclude a block of code
--list-tags to list available tags
</pre></div>
<p><a href="http://docs.ansible.com/ansible/latest/playbooks_tags.html">Read more</a></p>
<h4>LIMIT</h4>
<p>You can limit an execution of your tasks to defined hosts</p>
<div class="highlight"><pre>ansible-playbook playbooks/simple_playbook.yml --limit localhost

--limit my_hostname
--limit groupname
--limit some_prefix*
--limit hostname:group #JM
</pre></div>
<h3>Templates</h3>
<p>Templates are a powerful way to deliver some (partially) dynamic content.
Ansible uses <strong>Jinja2</strong> language to describe the template.</p>
<div class="highlight"><pre>Some static content

{{ a_variable }}

{% for item in loop_items %}
    this line item is {{ item }}
{% endfor %}
</pre></div>
<p>Jinja may have some limitations, but it is a powerful tool that you might like.</p>
<p>Please examine this simple example that installs apache2 and generates
index.html from the template
&quot;playbooks/roles/simple_apache_role/templates/index.html&quot;</p>
<div class="highlight"><pre lang="bash">$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>environment.sh
$<span class="w"> </span><span class="c1"># Now we would run the above playbook with roles</span>
<span class="o">(</span>venv<span class="o">)</span><span class="w"> </span>user@host:~/ansible-for-learnXinYminutes$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/simple_role.yml<span class="w"> </span>--tags<span class="w"> </span>apache2
</pre></div>
<h4>Jinja2 CLI</h4>
<p>You can use the jinja in the CLI too</p>
<div class="highlight"><pre lang="bash">ansible<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;echo {{ my_variable }}&#39;</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;my_variable=something, playbook_parameter=twentytwo&#39;</span><span class="w"> </span>localhost
</pre></div>
<p>In fact - jinja is used to template parts of the playbooks too</p>
<div class="highlight"><pre lang="yaml"><span class="c1"># check part of this playbook: playbooks/roles/sys_debug/tasks/debug_time.yml</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">local_action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shell date +&#39;%F %T&#39;</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ts</span>
<span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">  </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Timestamp</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ ts.stdout }}&quot;</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ts is defined and ts.stdout is defined</span>
<span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
</pre></div>
<h4>Jinja2 filters</h4>
<p>Jinja is powerful. It has many built-in useful functions.</p>
<div class="highlight"><pre># get first item of the list
{{ some_list | first() }}
# if variable is undefined - use default value
{{ some_variable | default(&#39;default_value&#39;) }}
</pre></div>
<p><a href="http://docs.ansible.com/ansible/latest/playbooks_filters.html">Read More</a></p>
<h3>ansible-vault</h3>
<p>To maintain <strong>infrastructure as code</strong> you need to store secrets. Ansible
provides a way to encrypt confidential files so you can store them in the
repository, yet the files are decrypted on-the-fly during ansible execution.</p>
<p>The best way to use it is to store the secret in some secure location, and
configure ansible to use them during runtime.</p>
<div class="highlight"><pre lang="bash"><span class="c1"># Try (this would fail)</span>
$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/vault_example.yml

$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>some_very_very_long_secret<span class="w"> </span>&gt;<span class="w"> </span>~/.ssh/secure_located_file

<span class="c1"># in ansible.cfg set the path to your secret file</span>
$<span class="w"> </span>vi<span class="w"> </span>ansible.cfg
<span class="w">  </span><span class="nv">ansible_vault_password_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>~/.ssh/secure_located_file

<span class="c1">#or use env</span>
$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">ANSIBLE_VAULT_PASSWORD_FILE</span><span class="o">=</span>~/.ssh/secure_located_file

$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/vault_example.yml

<span class="w">  </span><span class="c1"># encrypt the file</span>
$<span class="w"> </span>ansible-vault<span class="w"> </span>encrypt<span class="w"> </span>path/somefile

<span class="w">  </span><span class="c1"># view the file</span>
$<span class="w"> </span>ansible-vault<span class="w"> </span>view<span class="w"> </span>path/somefile

<span class="w">  </span><span class="c1"># check the file content:</span>
$<span class="w"> </span>cat<span class="w"> </span>path/somefile

<span class="w">  </span><span class="c1"># decrypt the file</span>
$<span class="w"> </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>path/somefile
</pre></div>
<h3>dynamic inventory</h3>
<p>You might like to know, that you can build your inventory dynamically.
(For Ansible) inventory is just JSON with proper structure - if you can
deliver that to ansible - anything is possible.</p>
<p>You do not need to reinvent the wheel - there are plenty of ready to use
inventory scripts for the most popular Cloud providers and a lot of in-house
popular usecases.</p>
<p><a href="http://docs.ansible.com/ansible/latest/intro_dynamic_inventory.html#example-aws-ec2-external-inventory-script">AWS example</a></p>
<div class="highlight"><pre lang="bash">$<span class="w"> </span>etc/inv/ec2.py<span class="w"> </span>--refresh
$<span class="w"> </span>ansible<span class="w"> </span>-m<span class="w"> </span>ping<span class="w"> </span>all<span class="w"> </span>-i<span class="w"> </span>etc/inv/ec2.py
</pre></div>
<p><a href="http://docs.ansible.com/ansible/latest/intro_dynamic_inventory.html">Read more</a></p>
<h3>ansible profiling - callback</h3>
<p>Playbook execution takes some time. It is OK. First make it run, then you may
like to speed things up. Since ansible 2.x there is built-in callback for task
execution profiling.</p>
<div class="highlight"><pre>vi ansible.cfg
# set this to:
callback_whitelist = profile_tasks
</pre></div>
<h3>facts-cache and ansible-cmdb</h3>
<p>You can pull some information about your environment from another host.
If the information does not change - you may consider using a facts_cache
to speed things up.</p>
<div class="highlight"><pre>vi ansible.cfg

# if set to a persistent type (not &#39;memory&#39;, for example &#39;redis&#39;) fact values
# from previous runs in Ansible will be stored.  This may be useful when
# wanting to use, for example, IP information from one group of servers
# without having to talk to them in the same playbook run to get their
# current IP information.
fact_caching = jsonfile
fact_caching_connection = ~/facts_cache
fact_caching_timeout = 86400
</pre></div>
<p>I like to use <code>jsonfile</code> as my backend. It allows to use another project
<code>ansible-cmdb</code> <a href="https://github.com/fboender/ansible-cmdb">(project on GitHub)</a> that generates a HTML page of your inventory
resources. A nice 'free' addition!</p>
<h3>Debugging ansible [chapter in progress]</h3>
<p>When your job fails - it is good to be effective with debugging.</p>
<ol>
<li>Increase verbosity by using multiple -v <strong>[ -vvvvv]</strong></li>
<li>If variable is undefined -
<code>grep -R path_of_your_inventory -e missing_variable</code></li>
<li>If variable (dictionary or a list) is undefined -
<code>grep -R path_of_your_inventory -e missing_variable</code></li>
<li>Jinja template debug</li>
<li>Strange behaviour - try to run the code 'at the destination'</li>
</ol>
<h3>Infrastructure as code</h3>
<p>You already know, that ansible-vault allows you to store your confidential data
along with your code. You can go further - and define your
ansible installation and configuration as code.
See <code>environment.sh</code> to learn how to install the ansible itself inside a
<code>virtualenv</code> that is not attached to your operating system (can be changed by
non-privileged user), and as additional benefit - upgrading version of ansible
is as easy as installing new version in new virtualenv. What is more, you can
have multiple versions of Ansible present at the same time.</p>
<div class="highlight"><pre lang="bash"><span class="c1"># recreate ansible 2.x venv</span>
$<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>venv2
$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>environment2.sh

<span class="c1"># execute playbook</span>
<span class="o">(</span>venv2<span class="o">)</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/ansible1.9_playbook.yml<span class="w"> </span><span class="c1"># would fail - deprecated syntax</span>

<span class="c1"># now lets install ansible 1.9.x next to ansible 2.x</span>
<span class="o">(</span>venv2<span class="o">)</span>$<span class="w"> </span>deactivate
$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>environment.1.9.sh

<span class="c1"># execute playbook</span>
<span class="o">(</span>venv1.9<span class="o">)</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>playbooks/ansible1.9_playbook.yml<span class="w"> </span><span class="c1"># works!</span>

<span class="c1"># please note that you have both venv1.9 and venv2 present - you need to (de)activate one - that is all</span>
</pre></div>
<h4>become-user, become</h4>
<p>In Ansible - to become <code>sudo</code> - use the <code>become</code> parameter. Use <code>become_user</code>
to specify the username.</p>
<div class="highlight"><pre>- name: Ensure the httpd service is running
  service:
    name: httpd
    state: started
  become: true
</pre></div>
<p>Note: You may like to execute Ansible with <code>--ask-sudo-pass</code> or add the user to
sudoers file in order to allow non-supervised execution if you require 'admin'
privileges.</p>
<p><a href="http://docs.ansible.com/ansible/latest/become.html">Read more</a></p>
<h2>Tips and tricks</h2>
<h4>--check -C</h4>
<p>Always make sure that your playbook can execute in 'dry run' mode (--check),
and its execution is not declaring 'Changed' objects.</p>
<h4>--diff -D</h4>
<p>Diff is useful to see nice detail of the files changed.
It compare 'in memory' the files like <code>diff -BbruN fileA fileB</code>.</p>
<h4>Execute hosts with 'regex'</h4>
<div class="highlight"><pre lang="bash">ansible<span class="w"> </span>-m<span class="w"> </span>ping<span class="w"> </span>web*
</pre></div>
<h4>Host groups can be joined, negated, etc</h4>
<div class="highlight"><pre lang="bash">ansible<span class="w"> </span>-m<span class="w"> </span>ping<span class="w"> </span>web*:!backend:monitoring:<span class="p">&amp;</span>allow_change
</pre></div>
<h4>Tagging</h4>
<p>You should tag some (not all) objects - a task in a playbook, all tasks
included form a role, etc. It allows you to execute the chosen parts of the
playbook.</p>
<h4>no_logs: True</h4>
<p>You may see, that some roles print a lot of output in verbose mode. There is
also a debug module. This is the place where credentials may leak. Use <code>no_log</code>
to hide the output.</p>
<h4>Debug module</h4>
<p>allows to print a value to the screen - use it!</p>
<h4>Register the output of a task</h4>
<p>You can register the output (stdout), rc (return code), stderr of a task with
the <code>register</code> command.</p>
<h4>Conditionals: when:</h4>
<h4>Loop: with, with_items, with_dict, with_together</h4>
<p><a href="http://docs.ansible.com/ansible/latest/playbooks_conditionals.html">Read more</a></p>
<h2>Additional Resources</h2>
<ul>
<li><a href="https://serversforhackers.com/c/an-ansible-tutorial">Servers For Hackers: An Ansible Tutorial</a></li>
<li><a href="https://www.redhat.com/en/blog/system-administrators-guide-getting-started-ansible-fast">A system administrator's guide to getting started with Ansible - FAST!</a></li>
<li><a href="https://www.ansible.com/products/tower">Ansible Tower</a> - Ansible Tower provides a web UI, dashboard and rest interface to ansible.</li>
<li><a href="https://github.com/ansible/awx">Ansible AWX</a> - The Open Source version of Ansible Tower.</li>
<li><a href="https://spacelift.io/blog/ansible-tutorial">Ansible Tutorial for Beginners: Ultimate Playbook &amp; Examples</a></li>
</ul>

        <hr>
        <p>
          Got a suggestion? A correction, perhaps? <a href="https://github.com/adambard/learnxinyminutes-docs/issues/new">Open an Issue</a> on the GitHub Repo, or make a <a href="https://github.com/adambard/learnxinyminutes-docs/edit/master/ansible.md">pull request</a> yourself!
        </p>
        <p class="contributed">
          Originally contributed by Jakub Muszynski, and updated by <a href="https://github.com/adambard/learnxinyminutes-docs/blame/master/ansible.md">10 contributors</a>.
        </p>

        <footer>
          <a style="float: left" rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width: 0; width: 80px; height: 28px; padding-bottom: 5px;" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg" /></a>
          <p>
            &copy; 2025
            <a href="http://github.com/sirkubax">Jakub Muszynski</a>,
            <a href="https://github.com/patmyron">Pat Myron</a>,
            <a href="https://github.com/divayprakash">Divay Prakash</a>
          </p>
        </footer>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const langSelect = document.getElementById('lang-select');
          langSelect?.addEventListener('change', () => {
            const selectedOption = langSelect.options[langSelect.selectedIndex];
            const url = selectedOption?.getAttribute('data-url');
            if (url) {
              window.location.href = url;
            }
          });
        });
      </script>
    </div>
  </body>
</html>